---
phase: 04-visualization
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - src/renderer/components/visualization/VisualizationPanel.tsx
  - src/renderer/components/visualization/ViewToggle.tsx
  - src/renderer/App.tsx
  - src/renderer/index.css
  - src/main/main.ts
autonomous: false
requirements: [VIZ-03, VIZ-04]

must_haves:
  truths:
    - "Visualization canvas fills the center of the UI as the dominant element"
    - "User can switch between radial and waveform views without audio interruption"
    - "View toggle is a small icon on the canvas itself (not in the control sidebars)"
    - "Full-viz toggle (hotkey or button) hides all controls, leaving only the canvas"
    - "Keyboard chord shortcuts remain active in full-viz mode"
    - "The entire app has the dark/glow aesthetic -- title bar, background, controls all match"
    - "Chord buttons overlay the canvas area (small, semi-transparent)"
    - "Window default aspect ratio is landscape ~16:9"
  artifacts:
    - path: "src/renderer/components/visualization/VisualizationPanel.tsx"
      provides: "View switcher container rendering RadialView or WaveformView based on vizMode"
      exports: ["VisualizationPanel"]
    - path: "src/renderer/components/visualization/ViewToggle.tsx"
      provides: "Small radial/waveform toggle icon overlaying the canvas"
      exports: ["ViewToggle"]
    - path: "src/renderer/App.tsx"
      provides: "Restructured layout: canvas-primary with collapsible sidebars and full-viz mode"
      contains: "VisualizationPanel"
    - path: "src/renderer/index.css"
      provides: "Dark/glow app restyle applied globally"
      contains: "glow"
    - path: "src/main/main.ts"
      provides: "16:9 default window dimensions"
      contains: "1280"
  key_links:
    - from: "src/renderer/components/visualization/VisualizationPanel.tsx"
      to: "synthStore.vizMode"
      via: "useSynthStore selector to choose RadialView vs WaveformView"
      pattern: "vizMode.*radial.*RadialView"
    - from: "src/renderer/App.tsx"
      to: "synthStore.fullViz"
      via: "useSynthStore selector to hide/show sidebars"
      pattern: "fullViz"
    - from: "src/renderer/App.tsx"
      to: "VisualizationPanel"
      via: "import and render in center section"
      pattern: "import.*VisualizationPanel"
---

<objective>
Integrate the visualization canvases into the app layout as the primary UI surface. Restructure the layout so the canvas dominates, add view mode switching, full-viz performance mode, chord button overlay, and restyle the entire app to match the dark/glow visualization aesthetic.

Purpose: VIZ-03 (switch between radial and waveform views) and VIZ-04 (visualization is the primary instrument UI). This transforms Schmidi from a control-panel synth into a visual instrument.
Output: VisualizationPanel.tsx, ViewToggle.tsx, restructured App.tsx, restyled index.css, 16:9 default window.
</objective>

<execution_context>
@/Users/aharbuz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aharbuz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-visualization/04-CONTEXT.md
@.planning/phases/04-visualization/04-RESEARCH.md
@.planning/phases/04-visualization/04-01-SUMMARY.md
@.planning/phases/04-visualization/04-02-SUMMARY.md
@src/renderer/App.tsx
@src/renderer/store/synthStore.ts
@src/renderer/index.css
@src/renderer/components/SlideModeUI.tsx
@src/renderer/components/ChordArc.tsx
@src/main/main.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: VisualizationPanel + ViewToggle + chord overlay</name>
  <files>
    src/renderer/components/visualization/VisualizationPanel.tsx
    src/renderer/components/visualization/ViewToggle.tsx
  </files>
  <action>
**VisualizationPanel.tsx** -- Container that holds the active visualization canvas and overlay elements:
- Reads `vizMode` from Zustand. Conditionally renders `<RadialView />` or `<WaveformView />` based on `vizMode`
- Container is `relative w-full h-full` (takes full space from parent flex)
- Renders the active canvas component filling the container
- Overlays (positioned absolute within the container):
  1. **ViewToggle** -- top-right corner of canvas
  2. **Chord buttons** -- bottom center, semi-transparent row of 7 chord degree buttons
  3. **Active chord indicator** -- brief text flash showing chord name when triggered (optional, Claude's discretion on whether this adds value without clutter)

**Chord button overlay:**
- Simplified version of SlideModeUI's chord targeting buttons, but styled for overlay:
  - Semi-transparent background (`bg-black/30 backdrop-blur-sm`)
  - Smaller buttons, horizontal row, rounded pill container
  - Each button shows Roman numeral (I-VII) and keyboard shortcut letter
  - Active chord highlighted with a subtle glow matching the visualization's track hue palette
  - Mouse down/up triggers `triggerSlideChord`/`releaseSlideChord` from Zustand (same as SlideModeUI)
  - In full-viz mode, these become more transparent or hide (Claude's discretion -- they may be distracting. Keyboard shortcuts still work regardless)
- Only show chord overlay when `slideMode` is true (the visualization is only meaningful in slide mode)

**ViewToggle.tsx** -- Small toggle icon in the top-right corner of the canvas:
- Two small icons: a circle/dot icon for radial, a wavy line icon for waveform (use inline SVG, same pattern as WaveformSelector icons)
- Current mode is highlighted (brighter), other is dimmed
- Click toggles `setVizMode` from Zustand
- Styled: `absolute top-3 right-3`, semi-transparent bg, small (24x24px icons), hover brightens
- Does NOT interrupt audio when switching (it only changes which canvas component renders)
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify VisualizationPanel conditionally renders RadialView/WaveformView based on vizMode. Verify chord overlay calls the same Zustand actions as SlideModeUI.
  </verify>
  <done>
VisualizationPanel renders the active view with overlay controls. ViewToggle switches between radial and waveform. Chord buttons overlay the canvas for mouse interaction. No audio interruption on view switch.
  </done>
</task>

<task type="auto">
  <name>Task 2: App layout restructure + full-viz mode + dark/glow restyle + window aspect ratio</name>
  <files>
    src/renderer/App.tsx
    src/renderer/index.css
    src/main/main.ts
  </files>
  <action>
**App.tsx** -- Restructure the layout to make visualization primary:

Current layout: `TitleBar | ModeToggle | [Left sidebar | Center (ChordArc/SlideModeUI) | Right sidebar] | StatusBar`

New layout when `slideMode` is true:
```
TitleBar (if not fullViz)
[Left sidebar (if not fullViz) | VisualizationPanel (flex-1, fills all available space) | Right sidebar (if not fullViz)]
StatusBar (if not fullViz)
```

When `slideMode` is false (synth mode):
- Keep the current layout exactly as-is (ChordArc in center, sidebars visible)
- The visualization is a slide mode feature

Changes:
- Import `VisualizationPanel` from `./components/visualization/VisualizationPanel`
- Read `fullViz` from Zustand: `const fullViz = useSynthStore((s) => s.fullViz)`
- When `slideMode && fullViz`: render ONLY `<VisualizationPanel />` filling the entire window (no TitleBar, no sidebars, no StatusBar, no ModeToggle). Add a small "exit full-viz" button (X icon or Escape hint text) in the top-left corner.
- When `slideMode && !fullViz`: render TitleBar, ModeToggle, then the 3-column layout with VisualizationPanel as center instead of SlideModeUI. Left and right sidebars remain.
- When `!slideMode`: existing layout unchanged (ChordArc center)

**Full-viz hotkey:**
- Add a `useEffect` with global `keydown` listener for `Escape` key (exits full-viz) and `F` key (toggles full-viz, but only when no modifier keys are held and the key isn't used for chord shortcuts). Actually, the chord keys are A S D F G H J -- F is one of them. Use `v` key instead (not in chord mapping). Or use backtick. Claude's choice: use `Escape` to exit full-viz, and add a small "expand" icon button on the VisualizationPanel (near ViewToggle, e.g. top-left) to enter full-viz. This avoids conflicting with chord keys.
- Keyboard chord shortcuts (A S D F G H J) MUST remain active in full-viz mode. The existing `useSlideKeyboard` and `useChordKeyboard` hooks use global `document.addEventListener` -- they work regardless of visible DOM elements (confirmed in research Pitfall 6). No changes needed to those hooks.

**index.css** -- Dark/glow restyle for the entire app:
- The app background is already `#0a0a0f` -- keep it
- Add a subtle glow treatment for control elements:
  - `.glow-border` utility: `border-color: rgba(6, 182, 212, 0.15)` (faint cyan border for cards/panels)
  - `.glow-text` utility: `text-shadow: 0 0 8px rgba(6, 182, 212, 0.3)` for active labels
- Restyle the TitleBar: make it blend into the dark theme (remove any lighter background, use very subtle bottom border with `rgba(255,255,255,0.03)`)
- Restyle the StatusBar: same treatment, very subtle, blends into the dark void
- Add a subtle animation for mode transitions: `@keyframes fade-in { from { opacity: 0 } to { opacity: 1 } }` and a `.fade-in` class with `animation: fade-in 0.2s ease`
- The ModeToggle button when in slide mode could have a subtle glow to indicate the "instrument is live"
- Controls in sidebars: ensure all existing components look cohesive with the dark void aesthetic. The existing gray-900/gray-800 palette is already dark -- just ensure consistency. No major rework needed; the main impact is the canvas filling the center.

**main.ts** -- Update default window dimensions to landscape 16:9:
- Change `defaultWidth: 1000` to `defaultWidth: 1280`
- Change `defaultHeight: 700` to `defaultHeight: 720`
- Keep `minWidth: 800` and change `minHeight: 500` to `minHeight: 450` (allow slightly shorter for widescreen)
- This gives a ~16:9 ratio. The windowStateKeeper persists the user's actual size, so this only affects first launch.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Run `npm start` (or `npx electron-forge start`) to visually verify:
1. In slide mode: canvas fills center, view toggle visible, chord overlay works
2. Full-viz mode: everything except canvas and overlay hides
3. Escape exits full-viz
4. Chord keyboard shortcuts work in full-viz mode
5. Synth mode: layout unchanged from Phase 3
6. Window opens at ~16:9 aspect ratio on fresh state
  </verify>
  <done>
Visualization is the primary UI in slide mode. Full-viz mode hides all chrome. View toggle and chord overlay live on the canvas. Dark/glow aesthetic applied globally. 16:9 default window. Keyboard shortcuts work in all modes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of complete Phase 4 visualization system</name>
  <files>none</files>
  <action>
Human verifies the complete Phase 4 visualization: radial convergence view with glowing orbs and bloom effects, waveform trace view with per-track colored oscilloscope lines, view mode switching, full-viz performance mode, canvas-primary layout, and dark/glow app restyle.
  </action>
  <verify>
Follow the how-to-verify steps below.
  </verify>
  <done>
User confirms all visualization features work correctly: orbs converge with bloom, waveforms align, view toggle works, full-viz mode hides chrome, keyboard shortcuts active in all modes, aesthetic is cohesive.
  </done>
  <what-built>Complete Phase 4 visualization system: radial convergence view with glowing orbs and bloom effects, waveform trace view with per-track colored oscilloscope lines, view mode switching, full-viz performance mode, canvas-primary layout, and dark/glow app restyle.</what-built>
  <how-to-verify>
1. Launch the app (`npm start` or `npx electron-forge start`)
2. Click "Start" on splash screen
3. Toggle to Slide mode (Synth/Slide switch)
4. **Radial view**: You should see glowing orbs representing slide tracks drifting in the center canvas area. The canvas should be the dominant UI element.
5. Press chord keys (A S D F G H J) -- orbs should move toward center as tracks converge. At convergence, there should be a visible bloom/flash effect.
6. **View toggle**: Click the radial/waveform toggle icon in the top-right of the canvas. Should switch to waveform traces showing per-track colored lines.
7. Press chord keys in waveform view -- traces should brighten and align as tracks converge.
8. **Full-viz mode**: Click the expand icon to enter full-viz. All sidebars, title bar, and status bar should hide. Only the canvas and small overlay controls remain.
9. Press chord keys in full-viz -- keyboard shortcuts should still work.
10. Press Escape to exit full-viz.
11. Toggle back to Synth mode -- layout should revert to Phase 3 ChordArc layout with no visualization.
12. **Overall aesthetic**: The whole app should feel dark, glowing, immersive -- like an instrument, not a control panel.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the visualization, layout, or aesthetic</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- In slide mode: canvas fills center, RadialView renders orbs, WaveformView renders traces
- View toggle switches modes without audio interruption
- Full-viz mode hides all chrome, keyboard shortcuts remain active
- Convergence bloom visible in radial view, flash payoff visible in waveform view
- Synth mode layout unchanged from Phase 3
- Window defaults to 1280x720 on first launch
- Dark/glow aesthetic cohesive across entire app
</verification>

<success_criteria>
The visualization IS the instrument interface. Radial view shows convergence as orbs spiraling to center with bloom at arrival. Waveform view shows frequency alignment over time. Users can switch views, toggle full-viz performance mode, and play entirely via keyboard with only the visual feedback. The app feels like a visual instrument, not a control panel.
</success_criteria>

<output>
After completion, create `.planning/phases/04-visualization/04-03-SUMMARY.md`
</output>
