---
phase: 01-audio-foundation
plan: 04
type: execute
wave: 4
depends_on:
  - "01-02"
  - "01-03"
files_modified:
  - src/renderer/components/VoiceButton.tsx
  - src/renderer/components/WaveformSelector.tsx
  - src/renderer/components/ADSRControls.tsx
  - src/renderer/components/EnvelopeCurve.tsx
  - src/renderer/App.tsx
autonomous: true
requirements:
  - AUDIO-01
  - AUDIO-02
  - AUDIO-03

must_haves:
  truths:
    - "User sees 8 voice buttons and can trigger them with mouse click"
    - "User presses keyboard keys (a,s,d,f,j,k,l,;) and hears corresponding voices"
    - "Voice buttons show animated feedback reflecting envelope stage (attack glow, sustain pulse, release fade)"
    - "Keyboard shortcut is shown via tooltip on hover"
    - "User clicks waveform icons (sine, square, sawtooth, triangle) and hears timbre change immediately"
    - "User adjusts ADSR sliders and sees numeric values update (e.g. 'A: 45ms')"
    - "User selects envelope preset and sliders snap to preset values"
    - "Envelope curve preview canvas updates in real-time as ADSR parameters change"
  artifacts:
    - path: "src/renderer/components/VoiceButton.tsx"
      provides: "Per-voice trigger button with keyboard binding and envelope animation"
      min_lines: 50
    - path: "src/renderer/components/WaveformSelector.tsx"
      provides: "Icon row for sine, square, sawtooth, triangle selection"
      min_lines: 30
    - path: "src/renderer/components/ADSRControls.tsx"
      provides: "4 sliders + numeric display + preset dropdown"
      min_lines: 60
    - path: "src/renderer/components/EnvelopeCurve.tsx"
      provides: "Canvas preview of ADSR envelope shape"
      min_lines: 40
  key_links:
    - from: "src/renderer/components/VoiceButton.tsx"
      to: "src/renderer/store/synthStore.ts"
      via: "onMouseDown calls triggerVoice, onMouseUp calls releaseVoice"
      pattern: "triggerVoice|releaseVoice"
    - from: "src/renderer/components/VoiceButton.tsx"
      to: "keyboard events"
      via: "global keydown/keyup listener maps to voice index"
      pattern: "keydown|keyup|DEFAULT_VOICE_KEYS"
    - from: "src/renderer/components/WaveformSelector.tsx"
      to: "src/renderer/store/synthStore.ts"
      via: "onClick calls setWaveform"
      pattern: "setWaveform"
    - from: "src/renderer/components/ADSRControls.tsx"
      to: "src/renderer/store/synthStore.ts"
      via: "onChange calls setADSR, preset change calls setPreset"
      pattern: "setADSR|setPreset"
    - from: "src/renderer/components/EnvelopeCurve.tsx"
      to: "src/renderer/utils/envelopeMath.ts"
      via: "calls computeEnvelopeCurve with current ADSR values"
      pattern: "computeEnvelopeCurve"
---

<objective>
Build the core instrument controls: 8 voice trigger buttons with keyboard mapping and envelope animation, waveform selector icons, ADSR parameter sliders with presets, and live envelope curve preview.

Purpose: These are the primary interaction surfaces for Phase 1 -- the user plays the instrument through voice buttons and shapes the sound through waveform and ADSR controls. All controls are wired to the audio engine via the Zustand store.
Output: Fully interactive voice triggers, waveform selection, and ADSR parameter controls integrated into the main layout.
</objective>

<execution_context>
@/Users/aharbuz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aharbuz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-audio-foundation/01-RESEARCH.md
@.planning/phases/01-audio-foundation/01-02-SUMMARY.md
@.planning/phases/01-audio-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Voice buttons with keyboard mapping and envelope animation</name>
  <files>
    src/renderer/components/VoiceButton.tsx
    src/renderer/components/WaveformSelector.tsx
    src/renderer/App.tsx
  </files>
  <action>
    IMPORTANT: Follow the Vital synth visual reference -- dark buttons with glowing accent colors.

    1. Create src/renderer/components/VoiceButton.tsx:
       - Props: voiceIndex (0-7), voiceState (from store), onTrigger, onRelease.
       - Display: note name (C3, D3, E3, F3, G3, A3, B3, C4) and keyboard shortcut letter.
       - Mouse interaction: onMouseDown triggers attack, onMouseUp triggers release. Also handle onMouseLeave to release if mouse leaves while held.
       - Keyboard: Add global keydown/keyup event listener (in a parent component or hook). Map keys a,s,d,f,j,k,l,; to voice indices 0-7. Prevent key repeat (check event.repeat).
       - Animated envelope feedback (per user decision -- this is LOCKED, not optional):
         - Idle: dark button, no glow
         - Attack: cyan glow intensifying (CSS transition or animation matching attack time)
         - Sustain: steady cyan pulse (subtle CSS animation)
         - Release: glow fading out (CSS transition matching release time)
         - Use voiceState.stage from the animation loop to determine current stage.
       - Tooltip on hover showing keyboard shortcut (e.g. "Press 'A'" for the first voice). Use title attribute or a custom tooltip with Tailwind.
       - Layout: 2 rows of 4 buttons (grid). Each button ~60x60px minimum.
       - data-testid="voice-button-{index}" for Playwright.

    2. Create src/renderer/components/WaveformSelector.tsx:
       - 4 icon buttons in a horizontal row (per user decision).
       - Each button shows a waveform icon (use SVG inline or Unicode approximations):
         - Sine: smooth wave ~
         - Square: square wave âŠ“
         - Sawtooth: sawtooth wave /|
         - Triangle: triangle wave /\
       - Active waveform button has cyan/teal highlight (background or border glow).
       - onClick: calls store.setWaveform(type).
       - Read currentWaveform from store for active state.

    3. Update src/renderer/App.tsx:
       - Replace placeholder main content with actual layout:
         - Left column: Voice button grid (2x4)
         - Center column: WaveformSelector row at top, ADSR controls below (placeholder div for now), envelope curve below that (placeholder div for now)
         - Right column: placeholder for volume + oscilloscope (Plan 05)
       - Add the keyboard event listener hook for voice triggering (useEffect with keydown/keyup on window).
       - Wire voice buttons to store.triggerVoice/releaseVoice.
  </action>
  <verify>
    `npm start` -- app shows 8 voice buttons in 2x4 grid.
    Click a voice button -- hear a tone.
    Press 'a' key -- hear the C3 tone (first voice).
    Press multiple keys simultaneously -- hear polyphonic output.
    Voice buttons glow during attack/sustain and fade on release.
    Hover shows keyboard shortcut tooltip.
    Click waveform icons -- timbre changes audibly.
    `npx tsc --noEmit` passes.
  </verify>
  <done>
    8 voice buttons with mouse + keyboard triggering, animated envelope stage feedback, and tooltips. Waveform selector with 4 icon buttons changing timbre globally. Polyphonic playback working.
  </done>
</task>

<task type="auto">
  <name>Task 2: ADSR controls with presets and live envelope curve preview</name>
  <files>
    src/renderer/components/ADSRControls.tsx
    src/renderer/components/EnvelopeCurve.tsx
  </files>
  <action>
    1. Create src/renderer/components/ADSRControls.tsx:
       - 4 vertical sliders (range inputs styled with Tailwind/CSS) for Attack, Decay, Sustain, Release.
       - Slider ranges:
         - Attack: 0.001 to 2.0 seconds (logarithmic feel preferred, but linear is acceptable)
         - Decay: 0.01 to 3.0 seconds
         - Sustain: 0.0 to 1.0 (gain level)
         - Release: 0.01 to 5.0 seconds
       - Numeric display next to each slider showing current value (per user decision -- LOCKED):
         - Time values: "A: 800ms" or "A: 0.8s" (use ms for values < 1s, seconds for >= 1s)
         - Sustain: "S: 70%" (percentage)
       - Preset selector dropdown/buttons above sliders:
         - Options: 'Pad (Drift)', 'Pluck (Snap)', 'Organ (Breathe)', 'Strings (Bloom)' (per user decision -- LOCKED dual naming)
         - Selecting a preset snaps all 4 sliders to preset values.
         - Manual slider adjustment after selecting a preset is fine (no "custom" preset indicator needed).
       - onChange for each slider: calls store.setADSR with updated values.
       - Read current ADSR values from store.

    2. Create src/renderer/components/EnvelopeCurve.tsx:
       - Canvas element (~300x120px, dark background).
       - Uses computeEnvelopeCurve() from envelopeMath.ts to generate curve points.
       - Draws the ADSR curve as a single smooth line (stroke, no fill) in cyan/teal accent color.
       - Updates in real-time as ADSR parameters change in the store (per user decision -- LOCKED).
       - Label the 4 stages on the canvas: A, D, S, R below the curve at phase boundaries.
       - Use requestAnimationFrame or useEffect to redraw when ADSR values change (useEffect on adsr values is sufficient -- no rAF needed for parameter-driven updates).
       - Dark background with subtle grid lines for visual reference.

    3. Integrate both components into App.tsx center column below WaveformSelector.
  </action>
  <verify>
    `npm start` -- ADSR sliders visible with numeric values.
    Move Attack slider -- numeric display updates (e.g. "A: 450ms"), envelope curve shape changes.
    Select "Pluck (Snap)" preset -- all sliders snap to preset values, curve shows sharp attack + fast decay.
    Select "Pad (Drift)" preset -- sliders show slow attack, long release, curve shows gentle shape.
    Trigger a voice -- hear the envelope shape (long attack = slow swell, short attack = immediate).
    `npx tsc --noEmit` passes.
  </verify>
  <done>
    4 ADSR sliders with numeric displays, 4 envelope presets with dual names, and a live envelope curve preview canvas. All controls wired to audio engine. Envelope shape audible on voice trigger.
  </done>
</task>

</tasks>

<verification>
1. Voice buttons trigger and release audio with mouse and keyboard
2. Keyboard mapping: a,s,d,f,j,k,l,; map to voices 0-7
3. Voice buttons show animated envelope stage feedback
4. Waveform selector changes timbre across all voices
5. ADSR sliders update envelope with numeric display
6. Preset selector loads correct ADSR values
7. Envelope curve canvas updates in real-time
8. Polyphonic output works (multiple keys held)
9. No clicks or pops on note trigger/release
10. `npx tsc --noEmit` passes
</verification>

<success_criteria>
All core instrument controls are functional: 8 voice buttons with keyboard mapping and envelope animation, waveform selection, ADSR parameter controls with presets, and live envelope curve preview. User can play the instrument and shape its sound.
</success_criteria>

<output>
After completion, create `.planning/phases/01-audio-foundation/01-04-SUMMARY.md`
</output>
