---
phase: 01-audio-foundation
plan: 05
type: execute
wave: 5
depends_on:
  - "01-04"
files_modified:
  - src/renderer/components/VolumeControl.tsx
  - src/renderer/components/Oscilloscope.tsx
  - src/renderer/components/StatusBar.tsx
  - .storybook/main.ts
  - .storybook/preview.ts
  - src/stories/VoiceButton.stories.tsx
  - src/stories/ADSRControls.stories.tsx
  - src/stories/WaveformSelector.stories.tsx
  - src/stories/VolumeControl.stories.tsx
  - e2e/app.spec.ts
  - playwright.config.ts
  - src/renderer/App.tsx
autonomous: false
requirements:
  - AUDIO-01
  - AUDIO-02
  - AUDIO-03
  - AUDIO-04

must_haves:
  truths:
    - "User adjusts master volume slider and output level changes smoothly"
    - "User sees oscilloscope showing live waveform when audio is playing"
    - "User sees status bar showing AudioContext state, sample rate, and base latency"
    - "Storybook runs and shows interactive stories for VoiceButton, ADSRControls, WaveformSelector, VolumeControl"
    - "Playwright e2e test launches app, clicks through splash, verifies voice buttons exist"
    - "User verifies full app functionality: launch, splash, audio, controls, visual feedback"
  artifacts:
    - path: "src/renderer/components/VolumeControl.tsx"
      provides: "Master volume vertical slider"
      min_lines: 20
    - path: "src/renderer/components/Oscilloscope.tsx"
      provides: "Small canvas waveform display from AnalyserNode"
      min_lines: 30
    - path: "src/renderer/components/StatusBar.tsx"
      provides: "Bottom bar showing AudioContext state, sample rate, latency"
      min_lines: 15
    - path: ".storybook/main.ts"
      provides: "Storybook configuration for React + Vite"
    - path: "src/stories/VoiceButton.stories.tsx"
      provides: "VoiceButton interactive stories"
    - path: "e2e/app.spec.ts"
      provides: "Basic Electron e2e test"
      min_lines: 20
    - path: "playwright.config.ts"
      provides: "Playwright configuration for Electron testing"
  key_links:
    - from: "src/renderer/components/VolumeControl.tsx"
      to: "src/renderer/store/synthStore.ts"
      via: "onChange calls setMasterVolume"
      pattern: "setMasterVolume"
    - from: "src/renderer/components/Oscilloscope.tsx"
      to: "src/renderer/audio/masterBus.ts"
      via: "reads analyser.getByteTimeDomainData in animation loop"
      pattern: "getByteTimeDomainData|analyser"
    - from: "src/renderer/components/StatusBar.tsx"
      to: "src/renderer/store/synthStore.ts"
      via: "reads audioStatus from store"
      pattern: "audioStatus|sampleRate|baseLatency"
    - from: "e2e/app.spec.ts"
      to: "src/renderer/components/SplashScreen.tsx"
      via: "locates splash-screen and start-button test IDs"
      pattern: "splash-screen|start-button"
---

<objective>
Complete the Phase 1 UI with volume control, oscilloscope, and status bar. Set up Storybook with component stories and Playwright with basic e2e tests. Verify the complete app with user.

Purpose: Finish all UI components, establish the testing infrastructure that subsequent phases will use, and verify the complete Phase 1 deliverable before moving on.
Output: Complete Phase 1 app with all controls, monitoring displays, component stories, e2e tests, and user verification.
</objective>

<execution_context>
@/Users/aharbuz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aharbuz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-audio-foundation/01-RESEARCH.md
@.planning/phases/01-audio-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Volume control + oscilloscope + status bar</name>
  <files>
    src/renderer/components/VolumeControl.tsx
    src/renderer/components/Oscilloscope.tsx
    src/renderer/components/StatusBar.tsx
    src/renderer/App.tsx
  </files>
  <action>
    1. Create src/renderer/components/VolumeControl.tsx:
       - Vertical slider (range input rotated with CSS transform or a vertical-oriented custom slider).
       - Range: 0 to 1 (maps to master gain).
       - Default: 0.7 (from store).
       - onChange: calls store.setMasterVolume().
       - Label: "Volume" or "VOL" above/below the slider.
       - Display current value as percentage (e.g. "70%").
       - Style: match dark theme, accent color on slider thumb/track.

    2. Create src/renderer/components/Oscilloscope.tsx:
       - Small canvas (~200x80px, dark background).
       - Reads waveform data from the master bus AnalyserNode.
       - Uses requestAnimationFrame to draw the waveform trace continuously.
       - Access analyser via VoiceManager.getMasterBus().analyser (get reference from store or context).
       - Draw: getByteTimeDomainData into Uint8Array, map to canvas Y coordinates, stroke path in cyan/green accent color.
       - When no audio is playing, shows a flat line at center.
       - Label: "SCOPE" or similar above the canvas.

    3. Create src/renderer/components/StatusBar.tsx:
       - 28px height bar at bottom of app (per user decision).
       - Shows: AudioContext state (running/suspended), sample rate (e.g. "48000 Hz"), base latency (e.g. "~5.3ms").
       - Read from store.audioStatus (updated by animation loop).
       - Subtle text, smaller font, monospace numbers.
       - Include compressor reduction indicator if space permits (e.g. "GR: -2.1dB").
       - Style: dark background slightly lighter than main (#111116), dim text (#666).

    4. Update App.tsx to integrate all new components:
       - Right column: VolumeControl (vertical) + Oscilloscope (below it).
       - Bottom: StatusBar (full width, below main content area).
       - Ensure layout is responsive to minimum window size (800x500).
  </action>
  <verify>
    `npm start` -- all components visible in correct positions.
    Adjust volume slider -- sound level changes smoothly.
    Trigger voices -- oscilloscope shows waveform activity.
    Status bar shows "running", sample rate, and latency values.
    Window at minimum size (800x500) -- layout is not broken.
    `npx tsc --noEmit` passes.
  </verify>
  <done>
    Volume control adjusts master gain smoothly. Oscilloscope shows live waveform. Status bar displays AudioContext diagnostics. All components integrated into the main layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Storybook setup + component stories + Playwright e2e</name>
  <files>
    .storybook/main.ts
    .storybook/preview.ts
    src/stories/VoiceButton.stories.tsx
    src/stories/ADSRControls.stories.tsx
    src/stories/WaveformSelector.stories.tsx
    src/stories/VolumeControl.stories.tsx
    e2e/app.spec.ts
    playwright.config.ts
  </files>
  <action>
    IMPORTANT: Use Context7 MCP to pull latest Storybook docs (@storybook/react-vite setup) and Playwright Electron docs BEFORE implementation.

    STORYBOOK:
    1. Initialize Storybook: `npx storybook@latest init --type react_vite`. This should detect the React+Vite setup.
    2. Configure .storybook/main.ts:
       - Framework: '@storybook/react-vite'
       - Stories: ['../src/stories/**/*.stories.@(ts|tsx)']
       - Ensure Tailwind CSS works in Storybook (import index.css in preview.ts).
    3. Configure .storybook/preview.ts:
       - Import '../src/renderer/index.css' for Tailwind styles.
       - Set dark background as default (using Storybook parameters.backgrounds).
    4. Create stories (per user decision -- LOCKED: only for interactive controls):
       - VoiceButton.stories.tsx: Story with a single voice button. Args for voiceIndex, voiceState (with different stages: idle, attack, sustain, release). Note: audio will work in Storybook since Web Audio is available in browser.
       - ADSRControls.stories.tsx: Story with ADSR sliders and preset selector. Show different presets as separate stories.
       - WaveformSelector.stories.tsx: Story showing all 4 waveform buttons with active state.
       - VolumeControl.stories.tsx: Story with volume slider.
    5. IMPORTANT: Components that use Electron APIs (preload) must be mocked or abstracted so they work in Storybook. If SplashScreen or TitleBar use preload APIs, those should NOT have stories (they're not in the interactive controls list anyway).

    PLAYWRIGHT:
    1. Create playwright.config.ts:
       - No webServer config needed (we're testing the Electron app, not a web server).
       - Set timeout to 30000ms.
       - Set testDir to 'e2e'.
    2. Create e2e/app.spec.ts:
       - Launch Electron app using `_electron.launch({ args: ['.'] })`.
       - Test 1: "splash screen shows and unlocks audio"
         - Verify splash-screen is visible.
         - Click start-button.
         - Verify splash-screen disappears.
         - Evaluate audioContext.state === 'running' via page.evaluate.
       - Test 2: "voice buttons are visible and interactive"
         - Verify 8 voice buttons exist (data-testid="voice-button-*").
       - Test 3: "waveform selector buttons exist"
         - Verify 4 waveform buttons exist.
       - Cleanup: close electron app in afterAll.
    3. Verify tests run: `npx playwright test` (may need `npx playwright install` first for browser deps).
       NOTE: Playwright Electron tests require the app to be built first. Verify the correct launch args.
  </action>
  <verify>
    `npx storybook dev` (or `npm run storybook`) -- Storybook loads with all 4 component stories visible and interactive.
    `npx playwright test` -- all e2e tests pass (app launches, splash works, voice buttons exist).
    `npx tsc --noEmit` passes with stories and test files included.
  </verify>
  <done>
    Storybook configured with stories for VoiceButton, ADSRControls, WaveformSelector, VolumeControl. Playwright configured with 3 basic Electron e2e tests. Both test systems run successfully.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 1 app</name>
  <files>n/a (verification checkpoint)</files>
  <action>
    Present the complete Phase 1 deliverable to the user for verification.

    What was built:
    - Electron app with frameless window and custom title bar
    - Splash screen that unlocks AudioContext
    - 8 voice buttons with keyboard mapping (a,s,d,f,j,k,l,;) and envelope animation
    - Waveform selector (sine, square, sawtooth, triangle)
    - ADSR controls with 4 presets (Pad/Drift, Pluck/Snap, Organ/Breathe, Strings/Bloom)
    - Live envelope curve preview canvas
    - Master volume control
    - Oscilloscope waveform display
    - Status bar with AudioContext diagnostics
    - Storybook component stories
    - Playwright e2e tests
    - Vitest unit tests for audio engine
  </action>
  <verify>
    User performs the following verification steps:
    1. Run `npm start` -- app should launch with splash screen
    2. Click "Click to Start" -- should transition to main instrument UI
    3. Click voice buttons -- hear individual tones, see glow animation
    4. Press keyboard keys a,s,d,f,j,k,l,; -- hear corresponding tones
    5. Hold multiple keys -- hear polyphonic output with NO clicks/pops
    6. Click sine, square, sawtooth, triangle icons -- timbre changes immediately
    7. Move ADSR sliders -- see numeric values and envelope curve update
    8. Select each preset -- hear distinct characters:
       - Pad (Drift): slow swell, long release
       - Pluck (Snap): instant attack, quick decay
       - Organ (Breathe): immediate on/off
       - Strings (Bloom): gradual bloom, lingering fade
    9. Move volume slider -- output level changes smoothly
    10. Look at oscilloscope -- waveform visible when playing
    11. Check status bar -- shows "running", sample rate, latency
    12. Verify audio response feels immediate (no perceptible delay)
    13. Run `npx storybook dev` -- stories load for interactive controls
    14. Run `npx playwright test` -- all e2e tests pass
    15. Run `npx vitest run` -- all unit tests pass
  </verify>
  <done>
    User types "approved" to complete Phase 1, or describes issues to address in a gap closure plan.
  </done>
</task>

</tasks>

<verification>
1. Volume slider changes master gain smoothly
2. Oscilloscope shows live waveform during audio playback
3. Status bar shows AudioContext state, sample rate, latency
4. Storybook loads with 4 component stories
5. Playwright tests pass (3 tests)
6. Vitest tests pass
7. Complete app verified by user against all Phase 1 success criteria
</verification>

<success_criteria>
Phase 1 is complete: a running Electron app with 8 persistent oscillator voices, per-voice ADSR envelopes, global waveform selection, anti-click AudioParam patterns, splash screen with AudioContext handling, all UI controls functional, monitoring displays active, testing infrastructure operational, and user verification passed.
</success_criteria>

<output>
After completion, create `.planning/phases/01-audio-foundation/01-05-SUMMARY.md`
</output>
