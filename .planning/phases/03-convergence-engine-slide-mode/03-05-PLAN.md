---
phase: 03-convergence-engine-slide-mode
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/audio/SlideTrack.ts
  - src/renderer/audio/SlideEngine.ts
  - src/renderer/hooks/useAudioInit.ts
autonomous: true
gap_closure: true
requirements: [SLIDE-01, SLIDE-04]

must_haves:
  truths:
    - "Slide engine is completely silent when app starts in synth mode"
    - "New slide tracks fade in smoothly when track count is increased (no pops)"
  artifacts:
    - path: "src/renderer/audio/SlideTrack.ts"
      provides: "Zero-gain constructor initialization"
      contains: "setValueAtTime(0"
    - path: "src/renderer/audio/SlideEngine.ts"
      provides: "Fade-in for new tracks in setTrackCount"
      contains: "scheduleGainRamp"
    - path: "src/renderer/hooks/useAudioInit.ts"
      provides: "Explicit pauseScheduler call after SlideEngine construction"
      contains: "pauseScheduler"
  key_links:
    - from: "src/renderer/audio/SlideTrack.ts"
      to: "AudioContext swellGain"
      via: "constructor sets swellGain.gain to 0"
      pattern: "swellGain\\.gain\\.setValueAtTime\\(0"
    - from: "src/renderer/hooks/useAudioInit.ts"
      to: "SlideEngine"
      via: "pauseScheduler after construction"
      pattern: "se\\.pauseScheduler"
---

<objective>
Fix slide engine audio bleed at startup and track count pops.

Purpose: Two UAT gaps share the same root cause -- SlideTrack constructor initializes swellGain to 0.1 (audible), causing: (1) slide engine audible in synth mode at app startup, (2) pops when adding new tracks via track count control. Both are fixed by initializing swellGain to 0 and adding proper fade-in paths.

Output: Silent slide engine at startup, pop-free track count changes.
</objective>

<execution_context>
@/Users/aharbuz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aharbuz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-convergence-engine-slide-mode/03-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Zero-gain SlideTrack constructor + pauseScheduler on init</name>
  <files>src/renderer/audio/SlideTrack.ts, src/renderer/hooks/useAudioInit.ts</files>
  <action>
In `src/renderer/audio/SlideTrack.ts`, change the swellGain initialization in the constructor from:

```ts
this.swellGain.gain.setValueAtTime(0.1, ctx.currentTime);
```

to:

```ts
this.swellGain.gain.setValueAtTime(0, ctx.currentTime);
```

This ensures every new SlideTrack starts completely silent. The engine's startScheduler/idle motion will ramp gain up when slide mode is activated.

In `src/renderer/hooks/useAudioInit.ts`, add a `pauseScheduler()` call immediately after constructing the SlideEngine (belt-and-suspenders -- ensures all initial tracks are silenced even if the constructor briefly sets non-zero gains during track creation):

After the line `const se = new SlideEngine(ctx, vm.getMasterBus().masterGain, DEFAULT_SLIDE_CONFIG);`, add:
```ts
se.pauseScheduler(); // Ensure slide tracks are silent until user toggles to slide mode
```

This must come BEFORE `setSlideEngine(se);` to guarantee no audible frame.

Do NOT change the trackGain default (0.7) -- that is per-track user volume, not proximity-driven.
  </action>
  <verify>Run `npx tsc --noEmit` from project root -- zero errors. Grep SlideTrack constructor for `setValueAtTime(0,` on swellGain line. Grep useAudioInit for `pauseScheduler`.</verify>
  <done>SlideTrack.ts constructor initializes swellGain to 0 (not 0.1). useAudioInit.ts calls pauseScheduler() after SlideEngine construction. App starts with zero slide audio in synth mode.</done>
</task>

<task type="auto">
  <name>Task 2: Fade-in for dynamically added tracks in SlideEngine.setTrackCount</name>
  <files>src/renderer/audio/SlideEngine.ts</files>
  <action>
In `src/renderer/audio/SlideEngine.ts`, modify the `setTrackCount` method's "add new tracks" branch.

Current code (around line 831-834):
```ts
const track = new SlideTrack(this.ctx, this.masterGain, this.rootFreq);
track.scheduleGainRamp(this.config.idleVolume, 0.05);
```

Since SlideTrack now starts at swellGain=0 (from Task 1), the scheduleGainRamp from 0 to idleVolume already creates a fade-in. But 50ms (0.05s) is too fast and can still cause perceptible onset pops. Change the ramp duration to 150ms for a smooth fade:

```ts
const track = new SlideTrack(this.ctx, this.masterGain, this.rootFreq);
track.scheduleGainRamp(this.config.idleVolume, 0.15); // 150ms fade-in to avoid pop
```

Also apply the same 150ms fade-in treatment to spawned overflow tracks in `spawnOverflowTracks` method. Find the line:
```ts
track.scheduleGainRamp(this.config.floorVolume, 0.01);
```
Change to:
```ts
track.scheduleGainRamp(this.config.floorVolume, 0.15); // 150ms fade-in to avoid pop
```

Leave the constructor's initial track creation loop as-is -- those tracks are created before startScheduler runs, so the gain ramp there from 0 to idleVolume over 10ms is fine (they won't be audible until startScheduler is called and the engine starts ticking).
  </action>
  <verify>Run `npx tsc --noEmit` from project root -- zero errors. Grep `setTrackCount` method for `0.15` ramp duration. Grep `spawnOverflowTracks` for `0.15` ramp duration.</verify>
  <done>New tracks added via setTrackCount fade in over 150ms from silence (swellGain 0 -> idleVolume). No instant onset pop. Spawned overflow tracks also fade in over 150ms.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. SlideTrack constructor: swellGain initialized to 0
3. useAudioInit: pauseScheduler called after SlideEngine construction
4. setTrackCount: new tracks ramp gain over 150ms (not 50ms)
5. spawnOverflowTracks: spawned tracks ramp gain over 150ms (not 10ms)
</verification>

<success_criteria>
- App starts in synth mode with zero slide engine audio
- Increasing track count in slide mode produces smooth fade-in (no pops)
- All existing slide mode behavior unchanged (convergence, departure, idle motion)
</success_criteria>

<output>
After completion, create `.planning/phases/03-convergence-engine-slide-mode/03-05-SUMMARY.md`
</output>
