---
phase: 03-convergence-engine-slide-mode
plan: 04
type: execute
wave: 4
depends_on:
  - 03-03
files_modified:
  - src/renderer/hooks/useAnimationLoop.ts
  - src/renderer/hooks/useChordKeyboard.ts
autonomous: false
requirements:
  - SLIDE-01
  - SLIDE-02
  - SLIDE-03
  - SLIDE-04
  - SLIDE-05

must_haves:
  truths:
    - "User toggles to slide mode and hears multiple tracks continuously gliding"
    - "User presses a chord and hears all sliding tracks arrive simultaneously"
    - "User hears track volume swell on approach and fade on departure"
    - "User changes track count and the count updates without audio glitches"
    - "User hears the solid anchor track alongside sliding tracks"
  artifacts:
    - path: "src/renderer/hooks/useAnimationLoop.ts"
      provides: "Updated animation loop that polls slide track states when in slide mode"
      contains: "slideTrackStates"
    - path: "src/renderer/hooks/useChordKeyboard.ts"
      provides: "Updated chord keyboard that is inactive during slide mode"
      contains: "slideMode"
  key_links:
    - from: "src/renderer/hooks/useAnimationLoop.ts"
      to: "src/renderer/audio/SlideEngine.ts"
      via: "polls getTrackStates in rAF loop when slideMode active"
      pattern: "getTrackStates"
---

<objective>
Final integration: update animation loop to poll slide track states, make chord keyboard mode-aware, and verify the complete slide mode experience end-to-end.

Purpose: Ties together all prior plans into a working, verifiable instrument. This plan handles the remaining integration seams and includes a human verification checkpoint for the core Schmidi mechanic.

Output: Updated useAnimationLoop.ts, updated useChordKeyboard.ts, verified working slide mode.
</objective>

<execution_context>
@/Users/aharbuz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aharbuz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-convergence-engine-slide-mode/03-CONTEXT.md
@.planning/phases/03-convergence-engine-slide-mode/03-01-SUMMARY.md
@.planning/phases/03-convergence-engine-slide-mode/03-02-SUMMARY.md
@.planning/phases/03-convergence-engine-slide-mode/03-03-SUMMARY.md
@src/renderer/hooks/useAnimationLoop.ts
@src/renderer/hooks/useChordKeyboard.ts
@src/renderer/store/synthStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update animation loop and chord keyboard for slide mode awareness</name>
  <files>
    src/renderer/hooks/useAnimationLoop.ts
    src/renderer/hooks/useChordKeyboard.ts
  </files>
  <action>
**useAnimationLoop.ts update:**
The existing animation loop polls voice states for Phase 1 UI feedback. Extend it to also poll slide track states when in slide mode.

1. Add import: `import { getSlideEngine } from '../store/synthStore';`
2. In the rAF callback, add a slide mode check:
   ```typescript
   // After existing voice state polling...
   const slideMode = useSynthStore.getState().slideMode;
   if (slideMode) {
     const se = getSlideEngine();
     if (se) {
       const trackStates = se.getTrackStates();
       useSynthStore.getState().updateSlideTrackStates(trackStates);
     }
   }
   ```
3. Use `useSynthStore.getState()` (not the hook selector) inside the rAF callback to avoid stale closures — this matches the existing pattern in the animation loop.

**useChordKeyboard.ts update:**
Make the chord keyboard inactive when slide mode is on, so that A-J keys only route to one mode at a time.

1. Add selector: `const slideMode = useSynthStore((s) => s.slideMode);`
2. In the useEffect, add an early return: `if (slideMode) return;` — this prevents keydown/keyup listeners from being registered when in slide mode.
3. Add `slideMode` to the useEffect dependency array so listeners are re-registered when mode changes.

This ensures clean mode separation: in synth mode, A-J triggers chords via Phase 2 engine. In slide mode, A-J triggers slide convergence via useSlideKeyboard.

**Also verify:** Run `npx tsc --noEmit` to ensure no type errors across the full project. If any compilation issues are found from the previous plans' integration, fix them here.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Run `npx eslint src/ --max-warnings=0` — no lint errors. Start the dev server with `npx vite --port 5199` and verify basic page load (no crash).
  </verify>
  <done>
useAnimationLoop polls slide track states when in slide mode. useChordKeyboard is inactive during slide mode. Full project compiles and lints cleanly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete slide mode experience</name>
  <what-built>
Complete slide mode implementation: SlideEngine audio core with N persistent sliding tracks, idle motion, simultaneous convergence to chord targets, proximity-based volume swell, hold/departure lifecycle, Model A (heat-seeker) + Model C (spawn-overflow), LFO micro-motion, configurable anchor voice, mode toggle UI, chord targeting buttons + keyboard, and ~30 configurable parameters with tooltips.
  </what-built>
  <action>Human verification of the complete slide mode experience.</action>
  <verify>All 5 SLIDE requirements verified by user interaction.</verify>
  <done>User confirms the core Schmidi mechanic works: converging glissandos, volume swell, anchor voice, configurable parameters.</done>
  <how-to-verify>
1. Start the dev server: `npx vite --port 5199` and open in browser (or launch Electron)
2. Click the splash screen to initialize audio
3. **Mode toggle test:** Click the "Slide" toggle in the header. Center panel should change from ChordArc to SlideModeUI.

4. **Idle motion test (SLIDE-02):** You should hear faint sliding tones (tracks at floor volume, gliding through pitch space). If movement mode is "stationary", change it to "slow drift" in the Idle Behavior controls.

5. **Convergence test (SLIDE-02):** Press a chord button (e.g., I) or press 'A' on keyboard. All tracks should glide toward the chord's notes and arrive simultaneously. The convergence should take ~1.5 seconds (default).

6. **Volume swell test (SLIDE-03):** During convergence, volume should swell as tracks approach the target. On arrival, tracks should be louder. On departure (release the chord), volume should fade back to floor.

7. **Track count test (SLIDE-04):** In the Track Model section, change track count to 3, then to 4. The number of audible tracks should change. No clicks or pops during the change.

8. **Anchor test (SLIDE-05):** Enable "Anchor" in Post-Arrival controls (should be on by default). Press a chord — you should hear both the sliding tracks converging AND a clean solid chord sound underneath.

9. **Configuration test:** Try adjusting these settings and hearing changes:
   - Convergence duration: set to 0 (should behave like instant synth), then 3 seconds (slow convergence)
   - Swell curve: switch between linear and exponential
   - Track model: switch to Spawn-overflow, press chords rapidly — new tracks should spawn

10. **Mode switch test:** Toggle back to Synth mode. ChordArc should reappear. Play chords normally. No residual sliding sounds. Toggle back to Slide mode — tracks should resume (if 'resume' behavior) or reset (if 'reset home' behavior).

**Expected behavior:**
- Tracks are ALWAYS audible (at floor volume during idle, swell during convergence)
- Convergence is SIMULTANEOUS — not staggered
- Mode toggle is clean — no orphaned audio

**Known acceptable limitations:**
- No visualization yet (Phase 4)
- No scale snapping yet (Phase 5)
- UI may be compact/dense due to number of controls
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors across entire project
2. `npx eslint src/ --max-warnings=0` — no lint errors
3. All 5 Phase 3 success criteria verified by human:
   - SC1: Toggle to slide mode, hear tracks gliding
   - SC2: Press chord, tracks arrive simultaneously
   - SC3: Volume swells on approach, fades on departure
   - SC4: Track count change without glitches
   - SC5: Anchor track plays alongside sliders
</verification>

<success_criteria>
The core Schmidi mechanic is audible and controllable. The user can toggle slide mode, hear converging glissandos, adjust configuration, and experience the "emerging chord" feel. All 5 SLIDE requirements pass verification.
</success_criteria>

<output>
After completion, create `.planning/phases/03-convergence-engine-slide-mode/03-04-SUMMARY.md`
</output>
