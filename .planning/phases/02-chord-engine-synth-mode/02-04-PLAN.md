---
phase: 02-chord-engine-synth-mode
plan: 04
type: execute
wave: 3
depends_on:
  - 02-03
files_modified:
  - src/renderer/App.tsx
  - src/renderer/components/PerTrackVolume.tsx
  - src/renderer/hooks/useChordKeyboard.ts
  - src/renderer/hooks/useAudioInit.ts
autonomous: false
requirements:
  - CHORD-03
  - CTRL-01
  - CTRL-02

must_haves:
  truths:
    - "User sees chord arc as the centerpiece of the instrument layout"
    - "User presses home row keys (A S D F G H J) and hears corresponding diatonic chords play"
    - "User holds multiple keys simultaneously and hears polychordal output"
    - "User releases a key and the chord fades via ADSR release (no instant cut, no hanging notes)"
    - "Master volume slider controls overall output level smoothly"
    - "Per-track volume panel expands/collapses and shows individual sliders when open"
    - "Key/mode selectors are visible and functional above the chord arc"
    - "Phase 1 voice button grid is replaced by chord arc -- no conflicting keyboard handlers"
  artifacts:
    - path: "src/renderer/App.tsx"
      provides: "New App layout with chord arc centerpiece, key/mode selectors, volume controls, oscilloscope"
      contains: "ChordArc"
    - path: "src/renderer/hooks/useChordKeyboard.ts"
      provides: "Keyboard handler mapping home row keys to chord trigger/release via store"
      exports: ["useChordKeyboard"]
    - path: "src/renderer/components/PerTrackVolume.tsx"
      provides: "Expandable panel with per-chord-group volume sliders"
      exports: ["PerTrackVolume"]
    - path: "src/renderer/hooks/useAudioInit.ts"
      provides: "Updated audio init hook that creates ChordVoiceManager alongside VoiceManager"
      contains: "ChordVoiceManager"
  key_links:
    - from: "src/renderer/hooks/useChordKeyboard.ts"
      to: "src/renderer/store/synthStore.ts"
      via: "triggerChordByDegree and releaseChordByDegree on keydown/keyup"
      pattern: "triggerChordByDegree|releaseChordByDegree"
    - from: "src/renderer/App.tsx"
      to: "src/renderer/components/ChordArc.tsx"
      via: "ChordArc component rendered as main instrument face"
      pattern: "<ChordArc"
    - from: "src/renderer/hooks/useAudioInit.ts"
      to: "src/renderer/audio/ChordVoiceManager.ts"
      via: "Creates ChordVoiceManager instance during audio initialization"
      pattern: "new ChordVoiceManager|setChordVoiceManager"
    - from: "src/renderer/App.tsx"
      to: "src/renderer/hooks/useChordKeyboard.ts"
      via: "useChordKeyboard() called in App for global keyboard handling"
      pattern: "useChordKeyboard"
---

<objective>
Wire everything together: new App layout with chord arc as centerpiece, keyboard handler for chord triggering, per-track volume panel, and updated audio initialization. This is the integration plan that makes the chord instrument playable.

Purpose: Plans 01-03 created the layers (music theory, audio pool, store, UI components). This plan assembles them into a working instrument. The user should be able to launch the app, select a key and mode, and play chords via keyboard or mouse with full ADSR envelope behavior.

Output: Fully playable chord instrument with new layout, keyboard controls, and volume management. Human verification checkpoint at the end.
</objective>

<execution_context>
@/Users/aharbuz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aharbuz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chord-engine-synth-mode/02-03-SUMMARY.md
@src/renderer/App.tsx
@src/renderer/hooks/useAudioInit.ts
@src/renderer/store/synthStore.ts
@src/renderer/components/ChordArc.tsx
@src/renderer/components/KeySelector.tsx
@src/renderer/components/ModeSelector.tsx
@src/renderer/components/VolumeControl.tsx
@src/renderer/components/Oscilloscope.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create keyboard hook, per-track volume, and update audio init</name>
  <files>
    src/renderer/hooks/useChordKeyboard.ts
    src/renderer/components/PerTrackVolume.tsx
    src/renderer/hooks/useAudioInit.ts
  </files>
  <action>
    **useChordKeyboard.ts:**
    Custom hook for chord keyboard triggering. Replaces Phase 1's inline keyboard handler in App.tsx.

    - Import CHORD_KEYS from music/musicTypes.ts: ['a','s','d','f','g','h','j']
    - Import triggerChordByDegree, releaseChordByDegree from store
    - Track held keys with useRef<Set<string>>
    - keydown handler:
      - If e.repeat, return (prevent key repeat)
      - Map key to degree: CHORD_KEYS.indexOf(key.toLowerCase()) + 1 (1-indexed degree)
      - If valid degree (1-7) and key not already held: add to held set, call triggerChordByDegree(degree)
    - keyup handler:
      - Map key to degree
      - If valid: remove from held set, call releaseChordByDegree(degree)
    - useEffect: add/remove global keydown/keyup listeners when audio is ready
    - Cleanup: remove listeners and clear held set

    **PerTrackVolume.tsx:**
    Expandable panel for per-chord-group volume control (per user decision: "hidden by default, expand to reveal").

    - Reads perTrackExpanded and togglePerTrackPanel from store
    - Collapse/expand toggle button (chevron icon or "Mix" label)
    - When expanded: shows 7 vertical range inputs (one per chord degree)
    - Each slider label: Roman numeral of the chord degree
    - Slider range: 0-1, step 0.01
    - Note: In Phase 2, per-track volume is conceptual -- the sliders are wired to store state but full per-voice-group gain routing is a refinement. For now, store the values and display them. The actual per-group gain nodes can be added as a refinement or in Phase 3. Document this scope boundary in the component.
    - Styling: slide-out panel from the right side, dark background, compact sliders

    **useAudioInit.ts (MODIFY):**
    Update the existing hook to also create a ChordVoiceManager during audio initialization.

    After existing VoiceManager creation:
    1. Import ChordVoiceManager and setChordVoiceManager from store
    2. After creating VoiceManager and getting masterBus:
       - Create ChordVoiceManager: `new ChordVoiceManager(ctx, masterBus.masterGain)`
       - Call `setChordVoiceManager(cvm)` to store in module-level ref
    3. The ChordVoiceManager's voices connect to the SAME masterGain as Phase 1 voices (shared master bus)
    4. On dispose: also dispose ChordVoiceManager
  </action>
  <verify>
    `npx tsc --noEmit` passes. All new files export correctly.
  </verify>
  <done>
    Keyboard hook maps A-J to 7 chord degrees with held-key tracking. Per-track volume panel renders with expand/collapse and 7 sliders. Audio init creates ChordVoiceManager alongside VoiceManager.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite App layout with chord arc centerpiece</name>
  <files>src/renderer/App.tsx</files>
  <action>
    Replace the Phase 1 instrument layout with the new chord instrument layout. Preserve SplashScreen, TitleBar, and StatusBar.

    New layout structure:
    ```
    h-screen flex flex-col
    ├── TitleBar
    ├── main (flex-1, flex, overflow-hidden)
    │   ├── Left column (key/mode selectors + waveform/ADSR controls)
    │   │   ├── KeySelector (circular, compact)
    │   │   ├── ModeSelector (segmented, below key selector)
    │   │   ├── WaveformSelector (existing Phase 1 component)
    │   │   └── ADSRControls (existing Phase 1 component)
    │   ├── Center (flex-1, chord arc as instrument face)
    │   │   └── ChordArc (fills center, arc pointing upward)
    │   └── Right column (volume + oscilloscope)
    │       ├── VolumeControl (existing, vertical slider = master volume per user decision)
    │       ├── Oscilloscope (existing)
    │       └── PerTrackVolume (expandable panel)
    └── StatusBar
    ```

    Key changes from Phase 1 layout:
    1. REMOVE: VoiceButton grid and its keyboard handler (replaced by ChordArc + useChordKeyboard)
    2. REMOVE: Phase 1 inline keydown/keyup handlers and heldKeysRef from App
    3. ADD: useChordKeyboard() hook call (handles all keyboard chord triggering)
    4. ADD: ChordArc as center content
    5. ADD: KeySelector and ModeSelector in left column
    6. ADD: PerTrackVolume in right column
    7. KEEP: WaveformSelector, ADSRControls, EnvelopeCurve, VolumeControl, Oscilloscope, StatusBar
    8. MOVE: EnvelopeCurve can go below ADSRControls in left column (compact placement)

    Remove VoiceButton import since it's no longer used in the main layout. The Phase 1 VoiceButton component file stays in place (not deleted) in case it's needed for a debug/legacy mode later.

    The center chord arc should feel like the dominant instrument face (per user specifics). Give it ample space. The left and right columns are control panels, not the main event.
  </action>
  <verify>
    `npx tsc --noEmit` passes. `npx vite build` succeeds. Dev server renders the new layout.
  </verify>
  <done>
    App layout rewritten: chord arc fills center as instrument face, key/mode selectors + controls in left column, volume + oscilloscope in right column. Phase 1 voice button grid replaced. Keyboard handling delegated to useChordKeyboard hook.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify playable chord instrument</name>
  <files>n/a (verification checkpoint)</files>
  <action>
    Present the complete Phase 2 chord instrument to the user for verification.

    What was built:
    - Chord arc showing 7 diatonic chords in semicircular layout
    - Color-coded buttons (tonic=indigo, subdominant=amber, dominant=rose)
    - Circular key selector (12 keys) + segmented mode selector (8 modes)
    - Keyboard triggering (A S D F G H J = 7 chords)
    - Polychordal support (hold multiple keys)
    - ADSR envelope on trigger/release
    - Master volume slider
    - Expandable per-track volume panel
    - Live key/mode switching retunes active voices

    How to verify:
    1. Launch: `npm start` (or `npx vite --port 5199` for browser testing)
    2. Click "Start" on splash screen
    3. **Chord arc visible:** 7 chord buttons in arc/semicircle layout, Roman numeral labels visible, color-coded by function
    4. **Click a chord:** Hold mouse on chord I (C major in default key). Should hear a C major triad with current waveform/ADSR.
    5. **Release chord:** Release mouse. Sound should fade via ADSR release, not cut instantly.
    6. **Keyboard play:** Press 'A' key. Chord I should trigger. Release 'A'. Sound fades.
    7. **Polychordal:** Hold 'A' and 'F' simultaneously. Two chords should sound together.
    8. **Key change:** Click 'G' on the key selector. Chord grid should update to show G major chords. If a chord was held, it should retune live.
    9. **Mode change:** Click 'dorian' on mode selector. Chord grid should update to dorian chords (first chord becomes minor).
    10. **Master volume:** Move the volume slider. Output level should change smoothly.
    11. **Per-track panel:** Click expand button on per-track volume panel. Should show 7 individual sliders.
    12. **No hanging notes:** After all keys released, silence should follow the release envelope. No stuck sounds.
    13. **Tonic chord larger:** Chord I button should be visually larger than the others.

    Resume signal: Type "approved" or describe any issues found.
  </action>
  <verify>User confirms all 13 verification steps pass.</verify>
  <done>Complete chord instrument verified as playable with correct chord generation, keyboard/mouse triggering, polychordal support, volume controls, and live key/mode switching.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no type errors
2. `npx vitest run` -- all tests pass
3. `npx vite build` -- production build succeeds
4. Human verification of playable instrument (Task 3 checkpoint)
</verification>

<success_criteria>
- Complete chord instrument is playable via mouse and keyboard
- Home row keys map to 7 diatonic chords
- Polychordal playback works (multiple simultaneous chords)
- Key/mode changes regenerate chord grid with live retuning
- ADSR envelope applies to chord trigger and release
- Master volume controls output smoothly
- Per-track volume panel expands/collapses
- No Phase 1 keyboard conflicts (old handlers removed)
- Layout feels like an instrument, not a settings panel
</success_criteria>

<output>
After completion, create `.planning/phases/02-chord-engine-synth-mode/02-04-SUMMARY.md`
</output>
