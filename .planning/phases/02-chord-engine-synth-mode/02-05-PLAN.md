---
phase: 02-chord-engine-synth-mode
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/audio/ChordVoiceManager.ts
  - src/renderer/store/synthStore.ts
  - src/renderer/components/PerTrackVolume.tsx
autonomous: true
requirements: [CTRL-01]
gap_closure: true

must_haves:
  truths:
    - "User expands per-track panel, moves a chord degree slider, and that chord's audio level changes independently"
    - "User adjusts degree I slider to 0 and degree I chord is silent while other chords play at normal volume"
    - "Per-track volume defaults to 0.7 for all 7 degrees on app launch"
  artifacts:
    - path: "src/renderer/store/synthStore.ts"
      provides: "perTrackVolumes state array and setPerTrackVolume action"
      contains: "perTrackVolumes"
    - path: "src/renderer/audio/ChordVoiceManager.ts"
      provides: "Per-degree GainNodes for independent volume control"
      contains: "degreeGains"
    - path: "src/renderer/components/PerTrackVolume.tsx"
      provides: "Controlled slider inputs wired to store setPerTrackVolume"
      contains: "onChange"
  key_links:
    - from: "src/renderer/components/PerTrackVolume.tsx"
      to: "src/renderer/store/synthStore.ts"
      via: "onChange -> setPerTrackVolume(degree, value)"
      pattern: "setPerTrackVolume"
    - from: "src/renderer/store/synthStore.ts"
      to: "src/renderer/audio/ChordVoiceManager.ts"
      via: "setPerTrackVolume action calls cvm.setDegreeVolume(degree, volume)"
      pattern: "setDegreeVolume"
    - from: "src/renderer/audio/ChordVoiceManager.ts"
      to: "Voice gain nodes"
      via: "Per-degree GainNode between voice gainNodes and masterGain"
      pattern: "degreeGains"
---

<objective>
Wire per-track volume sliders to functional per-degree audio routing, closing the one remaining gap in Phase 2 verification (success criterion #5: "User adjusts per-track volume sliders and individual track levels change independently").

Purpose: Complete CTRL-01 requirement. The visual panel exists but sliders are uncontrolled inputs with no effect on audio output. This plan adds per-degree GainNodes in ChordVoiceManager, store state + action, and wires the component onChange through the full stack.

Output: Fully functional per-track volume control — each of 7 chord degree sliders independently controls that degree's audio output level.
</objective>

<execution_context>
@/Users/aharbuz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aharbuz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chord-engine-synth-mode/02-VERIFICATION.md
@.planning/phases/02-chord-engine-synth-mode/02-04-SUMMARY.md
@src/renderer/audio/ChordVoiceManager.ts
@src/renderer/store/synthStore.ts
@src/renderer/components/PerTrackVolume.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add per-degree GainNodes to ChordVoiceManager and per-track state to synthStore</name>
  <files>
    src/renderer/audio/ChordVoiceManager.ts
    src/renderer/store/synthStore.ts
  </files>
  <action>
**ChordVoiceManager.ts — add per-degree gain routing:**

1. Add a `degreeGains` property: `private degreeGains: Map<number, GainNode>` initialized in constructor.
2. In the constructor, create 7 GainNodes (degrees 1-7), each connected to the `masterGain` destination. Set initial gain value to 0.7 (matching default per-track volume). Store in `degreeGains` map keyed by degree number (1-7).
3. Modify `triggerChord()`: instead of connecting voices directly to masterGain (which happens in Voice constructor), the voices need to route through the degree's GainNode. Since Voice connects to a `destination` GainNode in its constructor, and voices are pre-created in the pool connected to masterGain, we need a different approach:
   - Add a `private degreeGainFor(degree: number): GainNode` helper that returns the GainNode for a given degree (falls back to a default at gain 0.7 if degree somehow missing).
   - In `triggerChord()`, after allocating voices, disconnect each voice's output from masterGain and reconnect to the degree's GainNode. This requires Voice to expose a method for reconnecting its output.
   - **Better approach (simpler, no Voice changes):** Create the per-degree GainNodes between voices and masterGain at allocation time. Since Voice already connects `oscillator -> gainNode -> destination`, and `destination` is masterGain, we need to intercept. The cleanest way: add a `reconnectOutput(newDestination: GainNode)` method to Voice that disconnects `this.gainNode` from its current destination and reconnects to `newDestination`. Call this in `triggerChord()` to route through the degree GainNode. On `releaseChord()`, no need to reconnect back — the voice stays connected to whatever degree gain until next allocation.
   - Actually, the **simplest correct approach** avoiding Voice changes: Insert degree GainNodes in the chain. Each degree GainNode connects to masterGain. In `triggerChord`, for each allocated voice, call `this.voices[idx].gainNode` — but gainNode is private. So we DO need a minimal Voice API addition.
   - **Final approach (minimal, clean):** Add a `reconnect(destination: AudioNode)` method to Voice.ts that does `this.gainNode.disconnect(); this.gainNode.connect(destination);`. In ChordVoiceManager.triggerChord(), after allocating voices and setting frequencies, call `voice.reconnect(this.degreeGains.get(degree)!)` for each voice. This routes each chord's voices through the appropriate degree gain node. The degree GainNodes connect to masterGain. Chain becomes: oscillator -> voice gain (ADSR) -> degree gain (volume) -> masterGain -> compressor -> analyser -> destination.

4. Add `setDegreeVolume(degree: number, volume: number): void` method that sets the gain value on the degree's GainNode using anti-click AudioParam scheduling (cancel -> anchor -> linearRamp over 20ms, same pattern as masterBus.setMasterVolume).

5. Update `dispose()` to disconnect all degreeGains.

**Voice.ts — add reconnect method:**

Add a public method to Voice class:
```typescript
/** Reconnect voice output to a new destination node */
reconnect(destination: AudioNode): void {
  this.gainNode.disconnect();
  this.gainNode.connect(destination);
}
```

This is the minimal change needed. The Voice still manages its own ADSR envelope via its gainNode; we are just changing where that gainNode's output goes.

**synthStore.ts — add per-track volume state and action:**

1. Add `perTrackVolumes: number[]` to SynthState interface — array of 7 numbers, one per chord degree (index 0 = degree 1, etc.).
2. Add `setPerTrackVolume: (degree: number, volume: number) => void` to SynthState interface.
3. Initialize `perTrackVolumes` in the store to `[0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7]`.
4. Implement `setPerTrackVolume` action:
   - Call `chordVoiceManagerRef?.setDegreeVolume(degree, volume)` to update audio.
   - Update the `perTrackVolumes` array immutably: create a copy, set `copy[degree - 1] = volume`, then `set({ perTrackVolumes: copy })`.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root — must pass with zero errors. Run `npx vitest run` — all existing 87 tests must pass (no regressions). Grep for `perTrackVolumes` in synthStore.ts and confirm it exists as state with 7-element array initialization. Grep for `degreeGains` in ChordVoiceManager.ts and confirm it exists. Grep for `reconnect` in Voice.ts and confirm the method exists.
  </verify>
  <done>
synthStore has perTrackVolumes state (7 defaults at 0.7) and setPerTrackVolume action. ChordVoiceManager has 7 per-degree GainNodes routed to masterGain, triggerChord routes voices through degree GainNodes, and setDegreeVolume method exists with anti-click scheduling. Voice has reconnect method. All 87 existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire PerTrackVolume component to store and verify full stack</name>
  <files>
    src/renderer/components/PerTrackVolume.tsx
  </files>
  <action>
**PerTrackVolume.tsx — convert to controlled inputs wired to store:**

1. In `PerTrackSlider`, read per-track volume from store: `const volume = useSynthStore((s) => s.perTrackVolumes[degree - 1])`.
2. Read `setPerTrackVolume` action from store: `const setPerTrackVolume = useSynthStore((s) => s.setPerTrackVolume)`.
3. Replace the `defaultValue={defaultValue}` on the range input with `value={volume}`.
4. Add `onChange` handler: `onChange={(e) => setPerTrackVolume(degree, parseFloat(e.target.value))}`.
5. Remove the hardcoded `const defaultValue = 0.7;` local variable — no longer needed.
6. Remove the scope boundary comment block at lines 13-18 (the deferral note is no longer accurate).
7. Update the component JSDoc to reflect that sliders are now fully functional with per-degree audio routing.

**Verify full stack wiring:**

After modifying the component, run the full verification:
- `npx tsc --noEmit` — TypeScript must pass
- `npx vitest run` — all tests must pass
- Visually inspect: the slider should use `value={...}` (controlled) and `onChange={...}` (connected to store)
  </action>
  <verify>
Run `npx tsc --noEmit` — zero errors. Run `npx vitest run` — all tests pass including any new ones. Grep PerTrackVolume.tsx for `onChange` and `value={volume}` — both must be present. Grep for `defaultValue` — must NOT appear in the slider input. Grep for `setPerTrackVolume` — must appear in the component.
  </verify>
  <done>
PerTrackVolume sliders are controlled inputs reading from store perTrackVolumes and dispatching setPerTrackVolume on change. The full chain works: slider onChange -> store.setPerTrackVolume -> ChordVoiceManager.setDegreeVolume -> degree GainNode gain value update. Success criterion #5 is satisfied: "User adjusts per-track volume sliders and individual track levels change independently."
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vitest run` — all tests pass (87+ existing, zero failures)
3. PerTrackVolume.tsx uses controlled `value` prop (not `defaultValue`) with `onChange` handler
4. synthStore.ts has `perTrackVolumes: number[]` state and `setPerTrackVolume` action
5. ChordVoiceManager.ts has `degreeGains` Map with 7 GainNodes and `setDegreeVolume` method
6. Voice.ts has `reconnect(destination: AudioNode)` method
7. Audio chain: oscillator -> voice gain (ADSR) -> degree gain (per-track volume) -> masterGain -> compressor -> analyser -> destination
</verification>

<success_criteria>
- Phase 2 success criterion #5 is satisfied: moving any per-track slider changes that chord degree's audio output level independently of all others
- All 87+ existing tests continue to pass (zero regressions)
- TypeScript compiles cleanly
- CTRL-01 requirement fully met
</success_criteria>

<output>
After completion, create `.planning/phases/02-chord-engine-synth-mode/02-05-SUMMARY.md`
</output>
