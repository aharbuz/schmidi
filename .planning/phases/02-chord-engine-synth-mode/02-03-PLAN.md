---
phase: 02-chord-engine-synth-mode
plan: 03
type: execute
wave: 2
depends_on:
  - 02-01
  - 02-02
files_modified:
  - src/renderer/store/synthStore.ts
  - src/renderer/components/ChordArc.tsx
  - src/renderer/components/ChordButton.tsx
  - src/renderer/components/KeySelector.tsx
  - src/renderer/components/ModeSelector.tsx
autonomous: true
requirements:
  - CHORD-01
  - CHORD-02
  - CHORD-03

must_haves:
  truths:
    - "Zustand store holds selectedKey, selectedMode, chordGrid (7 ChordData), and activeChords state"
    - "Changing key or mode regenerates chordGrid and retunes any active voices"
    - "7 chord buttons are arranged in an arc/circle layout using CSS trig functions"
    - "Chord buttons show Roman numeral primary label, note name secondary, and are color-coded by harmonic function"
    - "Tonic chord (I) is visually larger than other chord buttons"
    - "Circular key selector shows 12 keys in circle-of-fifths order"
    - "Mode selector shows all 8 modes and highlights the active one"
  artifacts:
    - path: "src/renderer/store/synthStore.ts"
      provides: "Chord engine state slice (key, mode, chordGrid, activeChords, actions)"
      contains: "selectedKey"
    - path: "src/renderer/components/ChordArc.tsx"
      provides: "Arc layout container positioning 7 ChordButton components using CSS sin()/cos()"
      exports: ["ChordArc"]
    - path: "src/renderer/components/ChordButton.tsx"
      provides: "Single chord button with Roman numeral, note name, harmonic function color, active state animation"
      exports: ["ChordButton"]
    - path: "src/renderer/components/KeySelector.tsx"
      provides: "Circular selector for 12 musical keys in circle-of-fifths order"
      exports: ["KeySelector"]
    - path: "src/renderer/components/ModeSelector.tsx"
      provides: "Horizontal segmented control for 8 modes"
      exports: ["ModeSelector"]
  key_links:
    - from: "src/renderer/store/synthStore.ts"
      to: "src/renderer/music/chordEngine.ts"
      via: "generateDiatonicChords called on key/mode change"
      pattern: "generateDiatonicChords"
    - from: "src/renderer/store/synthStore.ts"
      to: "src/renderer/audio/ChordVoiceManager.ts"
      via: "Module-level ref for chord voice manager, triggerChord/releaseChord/retuneActiveChords"
      pattern: "chordVoiceManagerRef"
    - from: "src/renderer/components/ChordArc.tsx"
      to: "src/renderer/store/synthStore.ts"
      via: "useSynthStore for chordGrid, activeChords, triggerChord, releaseChord"
      pattern: "useSynthStore"
    - from: "src/renderer/components/KeySelector.tsx"
      to: "src/renderer/store/synthStore.ts"
      via: "useSynthStore for selectedKey, setKey action"
      pattern: "useSynthStore.*setKey"
---

<objective>
Extend the Zustand store with chord engine state and create the core UI components: chord arc with 7 buttons, circular key selector, and mode selector.

Purpose: This plan bridges the music theory layer (Plan 01) and audio layer (Plan 02) to the React UI. The store manages chord state and dispatches to both the chord engine (data) and ChordVoiceManager (audio). The chord arc IS the instrument face -- the visual centerpiece of the app.

Output: Extended synthStore with chord actions, plus 4 new React components (ChordArc, ChordButton, KeySelector, ModeSelector) ready to be composed into the App layout.
</objective>

<execution_context>
@/Users/aharbuz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aharbuz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chord-engine-synth-mode/02-01-SUMMARY.md
@.planning/phases/02-chord-engine-synth-mode/02-02-SUMMARY.md
@src/renderer/store/synthStore.ts
@src/renderer/music/musicTypes.ts
@src/renderer/music/chordEngine.ts
@src/renderer/audio/ChordVoiceManager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Zustand store with chord engine state and actions</name>
  <files>src/renderer/store/synthStore.ts</files>
  <action>
    Extend the existing synthStore (do NOT replace it -- Phase 1 state must remain functional).

    1. Add module-level ref for ChordVoiceManager (same pattern as voiceManagerRef):
       - `let chordVoiceManagerRef: ChordVoiceManager | null = null;`
       - Export `setChordVoiceManager(cvm)` and `getChordVoiceManager()` functions

    2. Add new state fields to SynthState interface:
       - `selectedKey: MusicalKey` (default: 'C')
       - `selectedMode: MusicalMode` (default: 'major')
       - `chordGrid: ChordData[]` (default: generateDiatonicChords('C', 'major'))
       - `activeChordDegrees: Set<number>` (default: empty Set -- degrees 1-7 currently held)
       - `perTrackExpanded: boolean` (default: false)

    3. Add new actions:
       - `setKey(key: MusicalKey)`:
         - Set selectedKey
         - Regenerate chordGrid via generateDiatonicChords(key, selectedMode)
         - Call chordVoiceManagerRef.retuneActiveChords(newChordGrid) for live retuning per user decision
       - `setMode(mode: MusicalMode)`:
         - Set selectedMode
         - Regenerate chordGrid via generateDiatonicChords(selectedKey, mode)
         - Call chordVoiceManagerRef.retuneActiveChords(newChordGrid) for live retuning
       - `triggerChordByDegree(degree: number)`:
         - Look up ChordData from chordGrid[degree - 1]
         - Call chordVoiceManagerRef.triggerChord(degree, chordData.frequencies, currentWaveform, adsr)
         - Add degree to activeChordDegrees Set (use new Set([...prev, degree]) for immutability)
       - `releaseChordByDegree(degree: number)`:
         - Call chordVoiceManagerRef.releaseByDegree(degree)
         - Remove degree from activeChordDegrees Set
       - `togglePerTrackPanel()`:
         - Toggle perTrackExpanded boolean

    4. Preserve ALL existing Phase 1 actions (setWaveform, setADSR, setPreset, etc.). When setWaveform or setADSR is called, also forward to chordVoiceManagerRef if it exists (so chord voices use the same waveform/ADSR as configured).

    Important: The store imports ChordVoiceManager type only, not the class itself. The module-level ref pattern avoids putting the manager in reactive state (same approach as Phase 1 VoiceManager).
  </action>
  <verify>
    `npx tsc --noEmit` passes. Store has all new fields and actions.
  </verify>
  <done>
    Zustand store extended with chord state (key, mode, chordGrid, activeChordDegrees) and actions (setKey, setMode, triggerChordByDegree, releaseChordByDegree). Live retuning triggers on key/mode change. Phase 1 state and actions remain intact.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ChordButton and ChordArc components with arc layout</name>
  <files>
    src/renderer/components/ChordButton.tsx
    src/renderer/components/ChordArc.tsx
  </files>
  <action>
    **ChordButton.tsx:**
    A single chord button representing one diatonic chord degree.

    Props:
    - chord: ChordData
    - isActive: boolean (from activeChordDegrees)
    - keyLabel: string (keyboard key, e.g. "A")
    - onTrigger: (degree: number) => void
    - onRelease: (degree: number) => void

    Rendering:
    - Circular/rounded button shape
    - Primary label: chord.romanNumeral (large text, centered)
    - Secondary label: chord.rootNote (smaller text below Roman numeral)
    - Key label: keyLabel in small text (always visible per user decision)
    - No individual note display per user decision -- just chord name

    Color coding by harmonic function (per user decision):
    - Tonic group (I, iii, vi): blue/indigo family (e.g. bg-indigo-600/hover:bg-indigo-500)
    - Subdominant group (ii, IV): amber/warm family (e.g. bg-amber-600/hover:bg-amber-500)
    - Dominant group (V, vii deg): rose/red family (e.g. bg-rose-600/hover:bg-rose-500)

    Size variation (per user decision):
    - Tonic chord (degree 1): larger size (w-20 h-20 or similar)
    - Other chords: standard size (w-16 h-16 or similar)

    Active state (per user decision):
    - When isActive: scale up slightly (transform scale-110), brighter color variant, subtle glow/shadow
    - Transition: transition-transform duration-100 for tactile feel

    Event handlers:
    - onMouseDown -> onTrigger(chord.degree)
    - onMouseUp -> onRelease(chord.degree)
    - onMouseLeave -> onRelease(chord.degree) (release if mouse leaves while held)

    **ChordArc.tsx:**
    Container that positions 7 ChordButton components along an arc.

    Uses CSS trig functions (sin/cos) for positioning per research recommendation:
    - CSS custom properties: --radius, --start-angle, --sweep, --count (7)
    - Each button gets --i (index 0-6) as inline style
    - Position calculation:
      left: calc(50% + var(--radius) * cos(var(--angle)))
      top: calc(var(--radius) + var(--radius) * sin(var(--angle)))
      where --angle = calc(var(--start-angle) + var(--sweep) * var(--i) / (var(--count) - 1))
    - Arc sweeps ~180 degrees (semicircle), opening upward so chord I is at the center-top

    Reads from store: chordGrid, activeChordDegrees, triggerChordByDegree, releaseChordByDegree
    Maps CHORD_KEYS array to chord buttons for keyLabel prop.

    The arc should feel like an instrument face (per user specifics), not a settings panel. Dark background, the chord buttons are the prominent visual elements with their harmonic function colors providing visual structure.
  </action>
  <verify>
    `npx tsc --noEmit` passes. Components render without errors (verify with `npx vite build` or dev server).
  </verify>
  <done>
    7 chord buttons arranged in a semicircular arc using CSS trig positioning. Buttons are color-coded by harmonic function, show Roman numeral + note name + key label, tonic chord is larger, active state scales up. Mouse interactions trigger/release chords via store.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create KeySelector and ModeSelector components</name>
  <files>
    src/renderer/components/KeySelector.tsx
    src/renderer/components/ModeSelector.tsx
  </files>
  <action>
    **KeySelector.tsx:**
    Circular selector showing 12 keys in circle-of-fifths order (per user decision: "circular selector, circle of fifths or chromatic wheel").

    Implementation:
    - Use CIRCLE_OF_FIFTHS array from musicTypes.ts
    - 12 key buttons positioned in a circle using CSS trig functions (same pattern as ChordArc but full 360 degrees)
    - CSS custom properties: --radius (~50px, compact), --i per key button
    - Each key button: small circular element with key letter (C, G, D, A, etc.)
    - Active key: highlighted (brighter color, border, or filled vs outline)
    - Click handler: calls store.setKey(key) which regenerates chord grid + retunes active voices

    Layout: compact circle (~120px diameter). Position in upper area of the layout (Claude's discretion: center-top above the chord arc, or left side).

    Styling: subtle, not competing with the chord arc. Use thin circles for inactive keys, filled circle for active. Text small but legible.

    **ModeSelector.tsx:**
    Horizontal segmented control showing 8 modes (per research discretion recommendation: segmented control to complement the circular key selector).

    Implementation:
    - Use MODES array from musicTypes.ts
    - Horizontal row of 8 pill-shaped buttons
    - Active mode: filled background, contrasting text
    - Inactive modes: outline/transparent, muted text
    - Click handler: calls store.setMode(mode) which regenerates chord grid + retunes active voices
    - Display labels: capitalize first letter of each mode name

    Layout: placed directly below the KeySelector. Compact width (~320px max), centered.

    Styling: clean, minimal. The segmented control should feel like a secondary setting, not the main instrument face. Use neutral colors (gray family) to avoid competing with the harmonic function colors on the chord arc.
  </action>
  <verify>
    `npx tsc --noEmit` passes. Components render without errors.
  </verify>
  <done>
    Circular key selector with 12 keys in circle-of-fifths order, active key highlighted. Horizontal segmented mode selector with 8 modes, active mode filled. Both dispatch to store on selection, triggering chord grid regeneration and live voice retuning.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no type errors
2. `npx vitest run` -- existing tests still pass (store changes are additive)
3. Visual check: components render in dev server with correct arc positioning, color coding, and selector interactions
</verification>

<success_criteria>
- Store extended with chord state without breaking Phase 1 functionality
- Key/mode change regenerates chord grid AND retunes active voices (live retuning)
- 7 chord buttons in arc layout using CSS trig functions
- Buttons color-coded: tonic=indigo, subdominant=amber, dominant=rose
- Tonic chord (I) visually larger than others
- Circular key selector with 12 keys, mode selector with 8 modes
- All components are self-contained and composable for App layout
</success_criteria>

<output>
After completion, create `.planning/phases/02-chord-engine-synth-mode/02-03-SUMMARY.md`
</output>
