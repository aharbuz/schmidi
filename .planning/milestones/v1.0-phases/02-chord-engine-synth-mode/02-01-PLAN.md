---
phase: 02-chord-engine-synth-mode
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/renderer/music/musicTypes.ts
  - src/renderer/music/chordEngine.ts
  - src/renderer/music/noteFrequency.ts
  - src/__tests__/chordEngine.test.ts
  - src/__tests__/noteFrequency.test.ts
  - package.json
autonomous: true
requirements:
  - CHORD-01
  - CHORD-02

must_haves:
  truths:
    - "generateDiatonicChords('C', 'major') returns 7 ChordData objects with correct Roman numerals, chord qualities, and harmonic functions"
    - "All 8 modes produce valid diatonic chord grids with correct triad qualities (major, minor, diminished)"
    - "buildTriadWithOctave correctly handles octave boundaries (B-D-F spans B4-D5-F5, not B4-D4-F4)"
    - "Circle of fifths key ordering and mode list constants are exported and match music theory"
  artifacts:
    - path: "src/renderer/music/musicTypes.ts"
      provides: "ChordData, HarmonicFunction, MusicalKey, MusicalMode types, CIRCLE_OF_FIFTHS, MODES constants"
      contains: "ChordData"
    - path: "src/renderer/music/chordEngine.ts"
      provides: "generateDiatonicChords function using tonal library"
      exports: ["generateDiatonicChords", "getChordQuality", "deriveRomanNumeral"]
    - path: "src/renderer/music/noteFrequency.ts"
      provides: "buildTriadWithOctave for correct octave assignment across chord notes"
      exports: ["buildTriadWithOctave"]
    - path: "src/__tests__/chordEngine.test.ts"
      provides: "Unit tests for all 8 modes chord generation"
    - path: "src/__tests__/noteFrequency.test.ts"
      provides: "Unit tests for octave boundary handling"
  key_links:
    - from: "src/renderer/music/chordEngine.ts"
      to: "tonal"
      via: "import { Mode, Note } from 'tonal'"
      pattern: "Mode\\.triads|Mode\\.notes|Note\\.freq"
    - from: "src/renderer/music/chordEngine.ts"
      to: "src/renderer/music/noteFrequency.ts"
      via: "buildTriadWithOctave for octave-aware note names"
      pattern: "buildTriadWithOctave"
---

<objective>
Create the music theory computation layer for diatonic chord generation from any key + mode combination, with comprehensive TDD coverage.

Purpose: This is the data foundation for the entire chord instrument. Every downstream component (chord arc UI, voice allocation, live retuning) depends on correct ChordData output. TDD ensures all 8 modes produce correct results before any audio or UI code is written.

Output: `src/renderer/music/` module with types, chord engine, and octave-aware frequency computation. Test suite proving correctness across all key/mode combinations.
</objective>

<execution_context>
@/Users/aharbuz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aharbuz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chord-engine-synth-mode/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install tonal and create music theory types</name>
  <files>
    package.json
    src/renderer/music/musicTypes.ts
  </files>
  <action>
    1. Install tonal: `npm install tonal`
    2. Create `src/renderer/music/musicTypes.ts` with:
       - `HarmonicFunction` type: 'tonic' | 'subdominant' | 'dominant'
       - `ChordQuality` type: 'major' | 'minor' | 'diminished' | 'augmented'
       - `ChordData` interface with fields: degree (1-7), romanNumeral (string), chordSymbol (string from tonal), rootNote (string), noteNames (string[] with octave e.g. "C4"), frequencies (number[] in Hz), harmonicFunction (HarmonicFunction), quality (ChordQuality)
       - `CIRCLE_OF_FIFTHS` const array: ['C','G','D','A','E','B','F#','Db','Ab','Eb','Bb','F']
       - `MODES` const array: ['major','minor','dorian','phrygian','lydian','mixolydian','aeolian','locrian']
       - `MusicalKey` type derived from CIRCLE_OF_FIFTHS
       - `MusicalMode` type derived from MODES
       - `HARMONIC_FUNCTIONS` const array mapping degree index (0-6) to HarmonicFunction: ['tonic','subdominant','tonic','subdominant','dominant','tonic','dominant']
       - `CHORD_KEYS` const array: ['a','s','d','f','g','h','j'] (home row for 7 chords)
  </action>
  <verify>
    `npx tsc --noEmit` passes. `node -e "require('tonal')"` resolves (or check package.json has tonal).
  </verify>
  <done>
    tonal is installed. musicTypes.ts exports all type definitions and constants needed by chordEngine and UI components. Types compile without errors.
  </done>
</task>

<feature>
  <name>Diatonic chord generation from key + mode</name>
  <files>
    src/renderer/music/noteFrequency.ts
    src/renderer/music/chordEngine.ts
    src/__tests__/noteFrequency.test.ts
    src/__tests__/chordEngine.test.ts
  </files>
  <behavior>
    noteFrequency.ts - buildTriadWithOctave(scaleNotes, degreeIndex, baseOctave):
    - Input: ["C","D","E","F","G","A","B"], 0, 4 -> ["C4","E4","G4"]
    - Input: ["C","D","E","F","G","A","B"], 6, 4 -> ["B4","D5","F5"] (octave crossing)
    - Input: ["D","E","F","G","A","B","C"], 0, 4 -> ["D4","F4","A4"]
    - Input: ["D","E","F","G","A","B","C"], 6, 4 -> ["C4","E4","G4"] (Dorian vii = C major triad, wraps back)
    - Input: ["B","C#","D","E","F#","G","A"], 0, 4 -> ["B4","D5","F#5"] (B Locrian, diminished tonic)

    chordEngine.ts - generateDiatonicChords(key, mode):
    - ("C", "major") -> 7 ChordData: I(C maj), ii(D min), iii(E min), IV(F maj), V(G maj), vi(A min), vii deg(B dim)
    - ("D", "dorian") -> 7 ChordData: i(D min), ii(E min), III(F maj), IV(G maj), v(A min), vi deg(B dim), VII(C maj)
    - ("B", "locrian") -> First chord is diminished (Bdim)
    - ("F", "lydian") -> Second chord check (should be major, not minor)
    - All 8 modes x C key: verify each returns exactly 7 chords with correct qualities
    - Frequencies: each chord's frequencies array has 3 values, all > 0, in ascending order
    - Roman numerals: uppercase for major, lowercase for minor, lowercase+deg for diminished
    - Harmonic functions: degree 1,3,6 = tonic; degree 2,4 = subdominant; degree 5,7 = dominant
  </behavior>
  <implementation>
    noteFrequency.ts:
    - Export `buildTriadWithOctave(scaleNotes: string[], degreeIndex: number, baseOctave: number = 4): string[]`
    - Use NOTE_ORDER = ['C','D','E','F','G','A','B'] to detect octave crossings
    - Triad indices: [0, 2, 4] (stacked thirds from degree in scale)
    - Track previous note letter index; if current <= previous, increment octave

    chordEngine.ts:
    - Import { Mode, Note } from 'tonal' and { buildTriadWithOctave } from './noteFrequency'
    - Import types from './musicTypes'
    - Export `getChordQuality(chordSymbol: string): ChordQuality` -- parse tonal's output: 'dim' suffix = diminished, 'm' suffix (not 'maj') = minor, else major
    - Export `deriveRomanNumeral(degree: number, quality: ChordQuality): string` -- uppercase/lowercase based on quality, add degree symbol for diminished
    - Export `generateDiatonicChords(key: string, mode: string): ChordData[]`:
      1. Get triads via Mode.triads(mode === 'major' ? 'ionian' : mode === 'minor' ? 'aeolian' : mode, key)
      2. Get scale notes via Mode.notes(mode === 'major' ? 'ionian' : mode === 'minor' ? 'aeolian' : mode, key)
      3. For each degree (0-6): build ChordData using getChordQuality, deriveRomanNumeral, buildTriadWithOctave, Note.freq()
      4. Assign harmonicFunction from HARMONIC_FUNCTIONS constant

    TDD cycle: Write tests FIRST for noteFrequency (RED), implement (GREEN). Then write tests for chordEngine (RED), implement (GREEN). Refactor if needed.
  </implementation>
</feature>

</tasks>

<verification>
1. `npx vitest run` -- all new tests pass
2. `npx tsc --noEmit` -- no type errors
3. Test coverage: all 8 modes tested for C key, octave boundary cases covered, edge cases (Locrian diminished tonic, Lydian) verified
</verification>

<success_criteria>
- tonal installed and importable
- generateDiatonicChords returns correct ChordData for all 8 modes
- buildTriadWithOctave handles octave crossings correctly
- Roman numerals follow music theory convention (uppercase major, lowercase minor, degree symbol diminished)
- All frequencies are positive numbers in ascending order per chord
- Test suite has 15+ test cases covering happy paths and edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/02-chord-engine-synth-mode/02-01-SUMMARY.md`
</output>
