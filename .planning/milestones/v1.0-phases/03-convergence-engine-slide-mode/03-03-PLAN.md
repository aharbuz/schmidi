---
phase: 03-convergence-engine-slide-mode
plan: 03
type: execute
wave: 3
depends_on:
  - 03-02
files_modified:
  - src/renderer/components/ModeToggle.tsx
  - src/renderer/components/SlideModeUI.tsx
  - src/renderer/components/SlideControls.tsx
  - src/renderer/App.tsx
autonomous: true
requirements:
  - SLIDE-01
  - SLIDE-02
  - SLIDE-03
  - SLIDE-04

must_haves:
  truths:
    - "User sees a Synth/Slide mode toggle in the app header that switches the center panel"
    - "Slide mode center panel shows a status area with track states and active chord indicator"
    - "All slide configuration controls are accessible in collapsible panels with tooltips on every control"
    - "Track count is adjustable via a numeric input/slider in the UI"
    - "App conditionally renders ChordArc (synth mode) or SlideModeUI (slide mode) in the center panel"
  artifacts:
    - path: "src/renderer/components/ModeToggle.tsx"
      provides: "Synth/Slide toggle button"
      min_lines: 15
    - path: "src/renderer/components/SlideModeUI.tsx"
      provides: "Slide mode center panel with status and chord targeting buttons"
      min_lines: 40
    - path: "src/renderer/components/SlideControls.tsx"
      provides: "All slide configuration control panels: idle, convergence, envelope, post-arrival, track model"
      min_lines: 100
    - path: "src/renderer/App.tsx"
      provides: "Mode-conditional center panel rendering"
      contains: "slideMode"
  key_links:
    - from: "src/renderer/components/ModeToggle.tsx"
      to: "src/renderer/store/synthStore.ts"
      via: "calls toggleSlideMode action"
      pattern: "toggleSlideMode"
    - from: "src/renderer/components/SlideControls.tsx"
      to: "src/renderer/store/synthStore.ts"
      via: "calls updateSlideConfig for each parameter change"
      pattern: "updateSlideConfig"
    - from: "src/renderer/App.tsx"
      to: "src/renderer/components/SlideModeUI.tsx"
      via: "conditional render when slideMode is true"
      pattern: "slideMode.*SlideModeUI"
---

<objective>
Build the complete slide mode UI: mode toggle, center panel with track status and chord buttons, and all configurable parameter controls with tooltips. Integrate into App.tsx.

Purpose: Makes the slide engine controllable and observable. The user declared "it's going to be mad" and wants all options exposed. Every idle, convergence, envelope, and post-arrival parameter gets a control with a tooltip.

Output: ModeToggle.tsx, SlideModeUI.tsx, SlideControls.tsx (consolidated controls), updated App.tsx.
</objective>

<execution_context>
@/Users/aharbuz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aharbuz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-convergence-engine-slide-mode/03-CONTEXT.md
@.planning/phases/03-convergence-engine-slide-mode/03-RESEARCH.md
@.planning/phases/03-convergence-engine-slide-mode/03-01-SUMMARY.md
@.planning/phases/03-convergence-engine-slide-mode/03-02-SUMMARY.md
@src/renderer/App.tsx
@src/renderer/store/synthStore.ts
@src/renderer/components/ChordArc.tsx
@src/renderer/components/ADSRControls.tsx
@src/renderer/audio/SlideTrack.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ModeToggle + SlideModeUI + update App layout</name>
  <files>
    src/renderer/components/ModeToggle.tsx
    src/renderer/components/SlideModeUI.tsx
    src/renderer/App.tsx
  </files>
  <action>
**ModeToggle.tsx:**
A toggle button placed in the app header (between TitleBar and main content, or at the top of the left column). Two states: "Synth" and "Slide". Styled as a segmented control (two adjacent buttons, active state highlighted).

```tsx
// Reads slideMode from store, calls toggleSlideMode
// Active mode gets bg-indigo-600 text-white, inactive gets bg-gray-800 text-gray-400
// Compact pill shape: rounded-full, h-8
```

Use Tailwind for styling. No external component library. Match the dark theme (bg-[#0a0a0f] palette) from App.tsx.

**SlideModeUI.tsx:**
The center panel content when slideMode is true. Replaces ChordArc.

Layout:
1. **Track status area** (top): Shows each track's state (idle/converging/held/departing) and current pitch. Read from `slideTrackStates` in store. Display as small horizontal bars or dots with color coding:
   - idle: gray
   - converging: amber (pulsing)
   - held: green
   - departing: rose (fading)
2. **Active chord indicator** (center): Shows which chord degree is currently targeted (or "No target" when idle). Large text display.
3. **Chord targeting buttons** (bottom): 7 buttons for degrees I-VII, styled similarly to ChordArc but in a horizontal row (not arc). Each button shows the chord name from chordGrid. Active degree highlighted. Mouse click triggers `triggerSlideChord(degree)`, mouse up triggers `releaseSlideChord()`. Add onMouseDown/onMouseUp handlers.

Read state from store: `slideMode`, `slideTrackStates`, `activeSlideDegree`, `chordGrid`.

Also integrate `useSlideKeyboard` hook call here (or in App.tsx — wherever the hook is active when slide mode is on).

**App.tsx update:**
1. Import ModeToggle, SlideModeUI, useSlideKeyboard.
2. Add `const slideMode = useSynthStore((s) => s.slideMode);` selector.
3. Call `useSlideKeyboard()` alongside existing `useChordKeyboard()`.
4. Place ModeToggle at the top of the main area (between TitleBar and the three-column layout), centered.
5. In the center section, conditionally render:
   ```tsx
   {slideMode ? <SlideModeUI /> : <ChordArc />}
   ```
6. When in slide mode, the left column ADSR controls title should indicate "Anchor ADSR" (per discretion decision). Add a conditional label: `{slideMode ? 'Anchor ADSR' : 'Envelope'}` above ADSRControls.
7. The existing useChordKeyboard should be inactive when slideMode is true. Check if useChordKeyboard already handles this, or add a guard. If the hook doesn't gate on slideMode, add a condition: either pass slideMode to the hook or use a separate mechanism. Simplest: in useChordKeyboard, check `useSynthStore((s) => s.slideMode)` and skip listeners when true. (Modify useChordKeyboard to be mode-aware.)

Also update `useAnimationLoop` or add a new effect: when slideMode is true and audioReady, poll `slideEngineRef?.getTrackStates()` each frame and call `updateSlideTrackStates(states)`. Add this to the existing rAF loop or create a parallel effect. Simplest: in the existing animation loop, add: if `slideMode`, also update slide track states.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Visually verify (manual or `npx vite --port 5199`): mode toggle appears, clicking "Slide" swaps center panel to SlideModeUI, clicking "Synth" restores ChordArc.
  </verify>
  <done>
ModeToggle renders a Synth/Slide segmented control. SlideModeUI shows track status, active chord, and 7 chord targeting buttons. App.tsx conditionally renders the correct center panel based on slideMode. useSlideKeyboard is active. useChordKeyboard is inactive in slide mode. Animation loop updates slide track states.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SlideControls — all configuration panels with tooltips</name>
  <files>src/renderer/components/SlideControls.tsx</files>
  <action>
Create a single `SlideControls.tsx` component containing ALL slide mode configuration controls, organized in collapsible sections. This component renders in the right column (replacing or alongside PerTrackVolume when in slide mode) or below the mode toggle — decide placement based on available space. Recommendation: render below the SlideModeUI center panel as a scrollable panel, or in the right column.

**Structure — 5 collapsible sections, each with a header toggle:**

**1. Track Model section:**
- Track model selector: radio buttons for 'Heat-seeker' / 'Spawn-overflow'. Maps to `slideConfig.trackModel`.
- Track count: number input or small slider, range 1-8, default 2. Maps to `slideConfig.trackCount`.
- Tooltip on track model: "Heat-seeker: tracks always exist, redirect on chord press. Spawn-overflow: new tracks spawn when chord pressed mid-convergence."
- Tooltip on track count: "Number of persistent sliding tracks. More tracks = richer convergence. Default: 2."

**2. Idle Behavior section:**
For each setting, render the appropriate control (select dropdown, slider, or radio group) with a tooltip. All map to slideConfig via `updateSlideConfig`.

Controls:
- Movement mode: select — stationary / slow drift / always moving. Tooltip: "How tracks move when no chord is pressed."
- Range type: select — free roam / orbit home / stay in scale. Tooltip: "Where tracks wander during idle."
- Starting position: select — root note / random / last known. Tooltip: "Where tracks start when entering slide mode."
- Correlation: select — independent / loosely correlated / unison. Tooltip: "How tracks relate to each other during idle."
- Correlation factor: slider 0-1 (only visible when correlation = loosely-correlated). Tooltip: "How strongly tracks follow each other. 0 = fully independent, 1 = locked together."
- Pitch boundary: select — musical window / key's octave / unconstrained. Tooltip: "Pitch range tracks can wander within."
- Edge behavior: select — reflect / wrap around / smooth curve. Tooltip: "What happens when a track hits the boundary."
- Movement speed: slider 0.5-10 (semitones/sec). Tooltip: "How fast tracks glide during idle. Higher = more energetic."
- Speed variation: slider 0-1. Tooltip: "Organic randomness in movement speed. 0 = mechanical, 1 = chaotic."
- Pitch movement: radio — continuous / scale-snapped. Tooltip: "Continuous: smooth glide. Scale-snapped: steps through scale degrees."
- Mode toggle behavior: radio — resume / reset home. Tooltip: "On re-entering slide mode: resume where tracks were, or reset to home pitch."
- Partitioning: radio — independent / partition range. Tooltip: "Independent: tracks roam entire range. Partition: each track gets its own pitch zone."
- Interaction: radio — none / avoid clustering. Tooltip: "Whether tracks try to avoid being at the same pitch."

**3. Convergence section:**
- Duration: slider 0-5 seconds. Tooltip: "Time for tracks to reach chord target. 0 = instant (normal synth behavior)."
- Easing: select — linear / ease-in / ease-out. Tooltip: "Linear: constant speed. Ease-in: starts slow, ends fast. Ease-out: starts fast, ends slow."
- Mode: radio — fixed time / distance proportional. Tooltip: "Fixed: all convergences take same time. Distance: duration scales with pitch distance."
- Mid-convergence: select — interrupt & retarget / finish then retarget / spawn overflow. Tooltip: "What happens when a new chord is pressed while tracks are still converging."
- Duration per octave: slider 0.5-3 seconds (only visible when mode = distance-proportional). Tooltip: "How long convergence takes per octave of pitch distance."
- Min duration: slider 0-1 seconds (only visible when mode = distance-proportional). Tooltip: "Minimum convergence time regardless of distance."

**4. Swell Envelope section:**
- Swell curve: radio — linear / exponential. Tooltip: "Linear: even volume ramp. Exponential: volume swells faster near arrival."
- Floor volume: slider 0-0.5. Tooltip: "Volume when track is far from target. Lower = more dramatic swell."
- Held volume: slider 0.3-1.0. Tooltip: "Volume when track arrives at target note."
- Idle volume: slider 0-0.3. Tooltip: "Volume during idle wandering (no chord pressed)."
- Departure fade time: slider 0.1-5 seconds. Tooltip: "How long volume fades after departure from target."

**5. Post-Arrival section:**
- Hold duration: slider 0.5-10 + "infinite" option (checkbox for infinite hold). Tooltip: "How long tracks hold at target before departing. Infinite = wait for chord release."
- Departure direction: select — random / inverse / continue. Tooltip: "Random: depart in random direction. Inverse: reverse approach path. Continue: keep going past target."
- Landing bounce: checkbox. Tooltip: "Tracks overshoot target slightly and bounce back on arrival."
- Bounce depth: slider 5-50 cents (only visible when bounce on). Tooltip: "How far past the target the track overshoots."
- Bounce decay: slider 0.05-0.5 seconds (visible when bounce on). Tooltip: "How quickly the bounce settles."
- Micro-motion: checkbox. Tooltip: "Subtle vibrato when tracks are held at target."
- Micro-motion depth: slider 2-30 cents (visible when micro-motion on). Tooltip: "Vibrato intensity. Lower = subtle shimmer, higher = wobbly."
- Micro-motion rate: slider 2-8 Hz (visible when micro-motion on). Tooltip: "Vibrato speed in Hz."
- Auto-cycle: checkbox. Tooltip: "Tracks auto-restart wandering while chord is held, creating continuous convergence cycles."
- Anchor enabled: checkbox. Tooltip: "Play a solid chord sound alongside the sliding tracks."
- Anchor fires on press: checkbox (visible when anchor on). Tooltip: "Anchor chord plays immediately on chord press."

**Tooltip implementation:**
Use a simple hover tooltip: a `<span>` with `title` attribute for quick implementation, OR a custom tooltip component with `group/hover` Tailwind pattern for better styling. Recommendation: use native `title` attributes initially (works immediately, no custom component needed). All controls MUST have tooltips — this is a locked requirement.

**Styling:**
- Dark theme consistent with existing app (bg-gray-900/bg-gray-800 panels, text-gray-300 labels)
- Collapsible sections: header with chevron icon, click to expand/collapse. Use local state for each section.
- Sliders: range inputs with numeric value display (matching ADSRControls pattern)
- Select dropdowns: styled `<select>` elements
- Compact layout — this panel will have many controls. Use small text (text-xs), tight spacing (gap-1).
- Scroll if content overflows.

**All controls call `updateSlideConfig` with the changed property.** Example: changing convergence duration calls `updateSlideConfig({ convergenceDuration: newValue })`.

Note: SlideControls only renders when `slideMode` is true. Place it in the right column of App.tsx below existing controls, or as a bottom panel. Integration: add `{slideMode && <SlideControls />}` to App.tsx's right column or create a dedicated slide controls area.

Update App.tsx to include SlideControls in the layout when slideMode is true. Recommended placement: replace the right column content with SlideControls (PerTrackVolume is less relevant in slide mode since tracks have their own volume), or add below PerTrackVolume with a scroll container.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Count tooltip coverage: every control element in SlideControls has a title attribute or tooltip. Verify all 5 sections are collapsible. All config values map to slideConfig properties.
  </verify>
  <done>
SlideControls.tsx renders all slide mode configuration controls in 5 collapsible sections (Track Model, Idle Behavior, Convergence, Swell Envelope, Post-Arrival). Every control has a tooltip. Controls are wired to updateSlideConfig. SlideControls is integrated into App.tsx layout and only visible in slide mode. Total control count: ~30 individual parameters.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Mode toggle switches between Synth and Slide views
3. SlideModeUI shows track states, active chord, and chord buttons
4. SlideControls has 5 collapsible sections with all ~30 configurable parameters
5. Every slide control has a tooltip
6. All controls call updateSlideConfig with correct property names
7. ChordArc hidden in slide mode, SlideModeUI hidden in synth mode
8. Keyboard handling: A-J keys route to correct mode (chord/slide)
</verification>

<success_criteria>
The user can toggle to slide mode and see the full slide mode UI: track status, chord buttons, and all configuration controls. Every parameter from the CONTEXT.md decisions is exposed as a UI control with a tooltip. The slide mode UI is visually consistent with the existing dark theme.
</success_criteria>

<output>
After completion, create `.planning/phases/03-convergence-engine-slide-mode/03-03-SUMMARY.md`
</output>
