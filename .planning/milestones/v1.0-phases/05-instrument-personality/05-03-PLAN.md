---
phase: 05-instrument-personality
plan: 03
type: execute
wave: 3
depends_on: [05-01, 05-02]
files_modified:
  - src/renderer/components/visualization/VisualizationPanel.tsx
  - src/renderer/components/SlideControls.tsx
  - src/renderer/components/visualization/RadialView.tsx
  - src/renderer/components/visualization/WaveformView.tsx
autonomous: false
requirements: [SLIDE-06, SLIDE-07, SLIDE-08, SLIDE-09]

must_haves:
  truths:
    - "User sees 4 preset buttons (Eerie, Bloom, Swarm, Custom) floating on the visualization canvas"
    - "User sees an intensity slider next to the preset buttons on the canvas overlay"
    - "User clicks a preset button and the active preset changes (button highlights)"
    - "User adjusts intensity slider and hears the slide character change in real-time"
    - "User finds post-arrival mode (Hold/Cycle), idle mode, scale picker, cycle touch duration, and micro-vibrato controls in the advanced controls panel"
    - "User toggles to silent mode and sees orbs diminished (smaller radius, reduced brightness) while still moving"
    - "User changes an advanced control value and sees the preset switch to Custom automatically"
  artifacts:
    - path: "src/renderer/components/visualization/VisualizationPanel.tsx"
      provides: "Preset overlay buttons + intensity slider floating on canvas"
      contains: "PRESET_NAMES"
    - path: "src/renderer/components/SlideControls.tsx"
      provides: "Advanced personality controls: idle mode, post-arrival mode, scale picker, cycle touch duration, micro-vibrato"
      contains: "postArrivalMode"
    - path: "src/renderer/components/visualization/RadialView.tsx"
      provides: "Silent mode dimmed orb rendering"
      contains: "silentMode"
    - path: "src/renderer/components/visualization/WaveformView.tsx"
      provides: "Silent mode dimmed trace rendering"
      contains: "silentMode"
  key_links:
    - from: "src/renderer/components/visualization/VisualizationPanel.tsx"
      to: "src/renderer/store/synthStore.ts"
      via: "useStore for activePreset, presetIntensity, applyPreset, setPresetIntensity"
      pattern: "applyPreset"
    - from: "src/renderer/components/SlideControls.tsx"
      to: "src/renderer/store/synthStore.ts"
      via: "useStore for idleMode, postArrivalMode, setIdleMode, setPostArrivalMode, setSnapScale"
      pattern: "setIdleMode"
    - from: "src/renderer/components/visualization/RadialView.tsx"
      to: "src/renderer/store/synthStore.ts"
      via: "slideTrackStates with silentMode flag for dimmed rendering"
      pattern: "silentMode"
---

<objective>
Build the UI layer for the personality system: preset buttons + intensity slider on the visualization canvas, advanced personality controls in the controls panel, and silent mode visual dimming in both canvas views.

Purpose: This is the player-facing surface of Phase 5. The preset buttons are the primary interaction -- choosing an instrument personality, not configuring parameters. The advanced controls in SlideControls let players override individual parameters. The silent mode visual dimming completes the idle mode experience.

Output: Modified `VisualizationPanel.tsx` with preset overlay, modified `SlideControls.tsx` with advanced personality controls, modified `RadialView.tsx` and `WaveformView.tsx` with silent mode dimming. Human verification confirms all 4 success criteria from the roadmap.
</objective>

<execution_context>
@/Users/aharbuz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aharbuz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-instrument-personality/05-CONTEXT.md
@.planning/phases/05-instrument-personality/05-RESEARCH.md
@.planning/phases/05-instrument-personality/05-01-SUMMARY.md
@.planning/phases/05-instrument-personality/05-02-SUMMARY.md
@src/renderer/components/visualization/VisualizationPanel.tsx (current overlay pattern)
@src/renderer/components/SlideControls.tsx (existing control sections to extend)
@src/renderer/components/visualization/RadialView.tsx (orb rendering to modify)
@src/renderer/components/visualization/WaveformView.tsx (trace rendering to modify)
@src/renderer/store/synthStore.ts (state and actions from Plan 01)
@src/renderer/audio/presets.ts (PRESET_NAMES, PresetName from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add preset overlay to VisualizationPanel and advanced controls to SlideControls, plus silent mode dimming</name>
  <files>
    src/renderer/components/visualization/VisualizationPanel.tsx
    src/renderer/components/SlideControls.tsx
    src/renderer/components/visualization/RadialView.tsx
    src/renderer/components/visualization/WaveformView.tsx
  </files>
  <action>
**VisualizationPanel.tsx -- Preset Overlay:**

Import `PRESET_NAMES, PresetName` from presets.ts. Import `useStore` selectors for `activePreset`, `presetIntensity`, `applyPreset`, `setPresetIntensity`.

Add a preset overlay bar at the top of the visualization panel, following the existing chord overlay pattern (absolute positioned, semi-transparent backdrop). Position: `absolute top-3 left-1/2 -translate-x-1/2 z-10`.

The overlay contains:
- 4 preset buttons in a row (Eerie, Bloom, Swarm, Custom)
  - Each button: `px-3 py-1 rounded-full text-xs transition-all`
  - Active preset: `bg-indigo-600/40 text-white border border-indigo-400/30 glow-text` (using existing glow class from Phase 4)
  - Inactive: `text-gray-500 hover:text-gray-300`
  - onClick: `applyPreset(name)`
  - Capitalize first letter for display text
- Intensity slider: `<input type="range" min={0} max={1} step={0.01}>`
  - Class: `w-20 h-1.5 accent-indigo-500`
  - Value: `presetIntensity`
  - onChange: `setPresetIntensity(parseFloat(e.target.value))`
  - Hidden when activePreset === 'custom' (custom has no intensity concept)

Wrap in a container with: `bg-black/30 backdrop-blur-sm border border-white/5 rounded-full flex items-center gap-2 px-3 py-1.5`

This overlay should appear in BOTH normal and full-viz modes (it's part of the instrument face). It should render only in slide mode (same condition as chord overlay).

**SlideControls.tsx -- Advanced Personality Controls:**

Add a new collapsible section titled "Personality" (or "Instrument Character") as the FIRST section in the controls panel (above the existing sections). Use the existing CollapsibleSection pattern.

Controls in this section:

1. **Idle Mode** -- RadioGroup<IdleMode> with 3 options:
   - 'silent': "Silent" (data-tooltip: "Tracks move visually but produce no sound")
   - 'quiet-sliding': "Quiet Sliding" (data-tooltip: "Tracks drift at low volume before chord press")
   - 'ambient-drone': "Ambient Drone" (data-tooltip: "Detuned root+fifth drone fades in/out with chords")
   - Value: `idleMode` from store
   - onChange: `setIdleMode(mode)`

2. **Post-Arrival Mode** -- RadioGroup<PostArrivalMode> with 2 options:
   - 'hold': "Hold" (data-tooltip: "Tracks stay on chord notes until released")
   - 'cycle': "Cycle" (data-tooltip: "Tracks arrive, hold briefly, depart, and reconverge (breathing)")
   - Value: `postArrivalMode` from store
   - onChange: `setPostArrivalMode(mode)`

3. **Cycle Touch Duration** -- SliderControl
   - Only visible when postArrivalMode === 'cycle'
   - Min: 0.2, Max: 5.0, Step: 0.1, Default from config
   - data-tooltip: "How long tracks hold at chord notes before departing (cycle mode)"
   - onChange: `updateSlideConfig({ holdDuration: value })`

4. **Scale Snap** -- CheckboxControl
   - Label: "Scale-Snapped Glissando"
   - data-tooltip: "Pitches gravitate toward scale degrees instead of continuous glide"
   - Checked: `slideConfig.pitchMovement === 'scale-snapped'`
   - onChange: `updateSlideConfig({ pitchMovement: checked ? 'scale-snapped' : 'continuous' })`

5. **Scale Picker** -- Two selects (key + mode), only visible when scale snap is enabled
   - Key: SelectControl for snapScaleKey (null = "Same as active key", or specific key from CIRCLE_OF_FIFTHS)
   - Mode: SelectControl for snapScaleMode (null = "Same as active mode", or specific mode from MODES)
   - onChange: `setSnapScale(key, mode)`
   - data-tooltip: "Scale for pitch snapping (defaults to active key/mode)"

**RadialView.tsx -- Silent Mode Dimming:**

Import `silentMode` from the slide track states (already in store as `slideTrackStates[].silentMode` from Plan 02).

In the orb rendering loop, when `trackState.silentMode === true`:
- Reduce orb radius to 60% of normal: multiply base radius by 0.6
- Reduce halo opacity to 30%: multiply globalAlpha for halo pass by 0.3
- Keep orb position calculation unchanged (tracks still move)

This creates the "visually diminished" effect from CONTEXT.md -- smaller, dimmer orbs that show track movement without audio.

**WaveformView.tsx -- Silent Mode Dimming:**

In the trace rendering loop, when `trackState.silentMode === true`:
- Reduce trace strokeStyle alpha to 30%: if current color is `rgba(h,s,l,0.8)`, change to `rgba(h,s,l,0.24)`
- Or: set `ctx.globalAlpha = 0.3` for the trace pass, then restore

This matches the RadialView dimming -- visible but muted traces.
  </action>
  <verify>
Run `npx tsc --noEmit` -- all 4 modified files must compile. Run `npx eslint src/renderer/components/visualization/VisualizationPanel.tsx src/renderer/components/SlideControls.tsx src/renderer/components/visualization/RadialView.tsx src/renderer/components/visualization/WaveformView.tsx --max-warnings=0`. Check that PRESET_NAMES is imported and mapped to buttons. Check that the new "Personality" section exists in SlideControls. Check that silentMode dimming exists in both canvas views.
  </verify>
  <done>
VisualizationPanel has preset buttons + intensity slider overlay. SlideControls has a new Personality section with idle mode, post-arrival mode, cycle touch duration, scale snap toggle, and scale picker controls. RadialView renders dimmed orbs (60% radius, 30% halo opacity) in silent mode. WaveformView renders dimmed traces (30% opacity) in silent mode. All compiles and lints cleanly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify all Phase 5 success criteria</name>
  <files>none (verification only)</files>
  <action>
Human verifies all Phase 5 success criteria. Launch the app with `npm start`.

**SLIDE-06 -- Slide Character Presets:**
1. Enter slide mode (click "Slide" toggle)
2. Look at the visualization canvas -- preset buttons (Eerie, Bloom, Swarm, Custom) should float at top center
3. Click "Eerie" -- slide character should become slow, creepy, with long convergence times
4. Click "Bloom" -- slide character should become lush, sweeping, with warm vibrato when held
5. Drag intensity slider right -- the effect should become more extreme
6. Click "Swarm" -- faster, more chaotic movement with potentially more tracks
7. Tweak any advanced control in the sidebar -- preset should auto-switch to "Custom"

**SLIDE-07 -- Post-Arrival Behavior:**
8. In advanced controls "Personality" section, set Post-Arrival to "Hold"
9. Press a chord key -- tracks converge and STAY at chord notes until you release
10. Set Post-Arrival to "Cycle"
11. Press and HOLD a chord key -- tracks should converge, hold briefly, depart, then reconverge (breathing pattern)

**SLIDE-08 -- Pre-Press Idle Mode:**
12. Set Idle Mode to "Silent" -- tracks should move visually (orbs visible but dimmed/smaller) but produce NO sound
13. Press a chord -- sound should play normally during convergence, then go silent again on release
14. Set Idle Mode to "Quiet Sliding" -- tracks should drift at low volume (default behavior)
15. Set Idle Mode to "Ambient Drone" -- you should hear a low drone on the root note that fades out when a chord is pressed and fades back in on release

**SLIDE-09 -- Scale-Snapped Glissando:**
16. In advanced controls, check "Scale-Snapped Glissando"
17. Listen for pitch movement that gravitates toward scale degrees (magnetic snap feel, spending more time on in-scale pitches)
18. Press a chord -- convergence should step through scale degrees (harp-like cascading approach) rather than smooth glide
19. Try changing the scale picker to a different key/mode and verify the snap targets change
  </action>
  <verify>All 19 verification steps pass. All 4 roadmap success criteria confirmed by human tester.</verify>
  <done>Phase 5 Instrument Personality verified: presets produce distinct characters, cycle mode breathes, idle modes work, scale-snap cascades through degrees.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npx eslint src/ --max-warnings=0` passes
3. App launches without errors
4. All 4 roadmap success criteria verified by human:
   - SLIDE-06: Different presets produce clearly different slide characters
   - SLIDE-07: Hold mode stays, Cycle mode breathes
   - SLIDE-08: Silent/Quiet/Drone idle modes work as described
   - SLIDE-09: Scale-snapped glissando produces harp-like cascading approach
</verification>

<success_criteria>
- Preset buttons and intensity slider visible on visualization canvas in slide mode
- Advanced personality controls in SlideControls panel (idle mode, post-arrival mode, scale snap, scale picker)
- Silent mode produces dimmed orbs/traces (visible movement without sound)
- All 4 SLIDE-06/07/08/09 behaviors verified by human tester
- Custom preset auto-activates when advanced controls diverge
</success_criteria>

<output>
After completion, create `.planning/phases/05-instrument-personality/05-03-SUMMARY.md`
</output>
