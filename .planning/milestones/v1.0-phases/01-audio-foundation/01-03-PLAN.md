---
phase: 01-audio-foundation
plan: 03
type: execute
wave: 3
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - src/renderer/store/synthStore.ts
  - src/renderer/hooks/useAudioInit.ts
  - src/renderer/hooks/useAnimationLoop.ts
  - src/renderer/App.tsx
  - src/renderer/components/SplashScreen.tsx
  - src/renderer/components/TitleBar.tsx
autonomous: true
requirements:
  - AUDIO-01
  - AUDIO-04

must_haves:
  truths:
    - "User sees splash screen with Schmidi branding and a start button on launch"
    - "User clicks start button and transitions to the main instrument UI"
    - "AudioContext is resumed on splash screen click"
    - "Custom title bar is draggable and shows app name"
    - "macOS traffic light buttons are visible and functional"
  artifacts:
    - path: "src/renderer/store/synthStore.ts"
      provides: "Zustand store for UI state (waveform, preset, ADSR, voice states, audio status)"
      exports: ["useSynthStore"]
      min_lines: 40
    - path: "src/renderer/hooks/useAudioInit.ts"
      provides: "Hook to initialize audio engine and connect to store"
      exports: ["useAudioInit"]
      min_lines: 20
    - path: "src/renderer/hooks/useAnimationLoop.ts"
      provides: "rAF loop for envelope animation and oscilloscope updates"
      exports: ["useAnimationLoop"]
      min_lines: 15
    - path: "src/renderer/App.tsx"
      provides: "Root component with splash/main routing"
      min_lines: 25
    - path: "src/renderer/components/SplashScreen.tsx"
      provides: "Splash screen with logo, version, tagline, start button"
      min_lines: 30
    - path: "src/renderer/components/TitleBar.tsx"
      provides: "Custom frameless title bar with drag region"
      min_lines: 15
  key_links:
    - from: "src/renderer/components/SplashScreen.tsx"
      to: "src/renderer/hooks/useAudioInit.ts"
      via: "onClick calls initAudio which resumes AudioContext"
      pattern: "initAudio|ensureAudioRunning"
    - from: "src/renderer/hooks/useAudioInit.ts"
      to: "src/renderer/audio/VoiceManager.ts"
      via: "creates VoiceManager instance"
      pattern: "VoiceManager"
    - from: "src/renderer/store/synthStore.ts"
      to: "src/renderer/audio/VoiceManager.ts"
      via: "store actions call VoiceManager methods"
      pattern: "voiceManager"
    - from: "src/renderer/App.tsx"
      to: "src/renderer/components/SplashScreen.tsx"
      via: "conditional rendering based on audioReady state"
      pattern: "audioReady|isStarted"
---

<objective>
Create the Zustand state management, audio initialization hooks, and app shell UI (splash screen, title bar, root component routing).

Purpose: Bridge the audio engine to the React UI. The splash screen unlocks AudioContext (per user decision), the store holds all UI-visible state, and the animation loop drives visual feedback.
Output: App launches with splash screen, transitions to main instrument layout on click, AudioContext running.
</objective>

<execution_context>
@/Users/aharbuz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aharbuz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-audio-foundation/01-RESEARCH.md
@.planning/phases/01-audio-foundation/01-01-SUMMARY.md
@.planning/phases/01-audio-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Zustand store + audio hooks</name>
  <files>
    src/renderer/store/synthStore.ts
    src/renderer/hooks/useAudioInit.ts
    src/renderer/hooks/useAnimationLoop.ts
  </files>
  <action>
    1. Create src/renderer/store/synthStore.ts using Zustand:
       - State shape:
         - audioReady: boolean (false until splash click)
         - currentWaveform: WaveformType ('sine' default)
         - currentPreset: string ('Pad (Drift)' default)
         - adsr: ADSRValues (from default preset)
         - masterVolume: number (0.7 default)
         - voiceStates: VoiceState[] (8 entries, all idle)
         - audioStatus: { state: string, sampleRate: number, baseLatency: number }
       - Actions:
         - setAudioReady(ready: boolean)
         - setWaveform(type: WaveformType) -- calls voiceManager.setWaveform()
         - setPreset(name: string) -- looks up preset, updates adsr, calls voiceManager
         - setADSR(adsr: ADSRValues) -- updates store + calls voiceManager
         - setMasterVolume(vol: number) -- updates store + calls voiceManager master bus
         - triggerVoice(index: number) -- calls voiceManager.triggerAttack()
         - releaseVoice(index: number) -- calls voiceManager.triggerRelease()
         - updateVoiceStates(states: VoiceState[])
         - updateAudioStatus(status)
       - The store holds a reference to the VoiceManager instance (set during init). Actions that affect audio call VoiceManager methods directly.
       - IMPORTANT: The VoiceManager reference is NOT React state -- store it as a plain field using Zustand's `set` outside of the reactive state, or use a module-level variable.

    2. Create src/renderer/hooks/useAudioInit.ts:
       - Returns { initAudio: () => Promise<void>, audioReady: boolean }
       - initAudio(): creates VoiceManager (which creates AudioContext + master bus + 8 voices), stores reference in synthStore, calls ensureAudioRunning(), sets audioReady to true, updates audioStatus.
       - This is called ONCE from the splash screen's start button click.

    3. Create src/renderer/hooks/useAnimationLoop.ts:
       - Uses requestAnimationFrame loop (start on mount, cancel on unmount).
       - On each frame: reads VoiceManager.getVoiceStates() and calls store.updateVoiceStates(). Reads audioContext state and calls store.updateAudioStatus().
       - The loop is lightweight -- just polling states, not computing audio.
       - Only runs when audioReady is true.
  </action>
  <verify>
    `npx tsc --noEmit` -- zero type errors.
    Store can be instantiated and all actions called without errors (verified during integration with App.tsx).
  </verify>
  <done>
    Zustand store manages all UI state with actions wired to VoiceManager. useAudioInit creates the audio engine on demand. useAnimationLoop polls voice states at 60fps.
  </done>
</task>

<task type="auto">
  <name>Task 2: Splash screen + title bar + App shell</name>
  <files>
    src/renderer/App.tsx
    src/renderer/components/SplashScreen.tsx
    src/renderer/components/TitleBar.tsx
  </files>
  <action>
    IMPORTANT: Follow the Vital synth visual reference -- dark background (#0a0a0f or similar), glowing accents (cyan/teal), clean typography.

    1. Create src/renderer/components/SplashScreen.tsx:
       - Full-screen overlay with dark background.
       - Centered content: Schmidi logo text (large, stylized -- use CSS text styling, no image needed), version number (from preload API or hardcoded "v0.1.0"), tagline (e.g. "Convergence Synthesizer"), and a prominent "Click to Start" button.
       - Button has a subtle glow/pulse animation (CSS keyframes, cyan/teal accent color).
       - onClick: calls initAudio() from useAudioInit hook, which resumes AudioContext and transitions state.
       - data-testid="splash-screen" on container, data-testid="start-button" on button (for Playwright).

    2. Create src/renderer/components/TitleBar.tsx:
       - 38px height bar at top of app.
       - CSS: -webkit-app-region: drag for window dragging.
       - Left side: padding for macOS traffic lights (80px on macOS, 0 on others -- read platform from preload API).
       - Center: "Schmidi" text (small, subtle).
       - All interactive elements inside title bar must have -webkit-app-region: no-drag.
       - Dark background matching app theme.

    3. Update src/renderer/App.tsx:
       - Conditional rendering: if !audioReady, show SplashScreen. If audioReady, show main layout.
       - Main layout structure (placeholder content for now):
         ```
         <div className="h-screen flex flex-col bg-[#0a0a0f] text-white">
           <TitleBar />
           <main className="flex-1 flex">
             {/* Voice buttons, controls, etc. will go here in Plans 04/05 */}
             <div className="flex-1 flex items-center justify-center text-gray-500">
               Instrument controls will appear here
             </div>
           </main>
           {/* StatusBar will go here in Plan 05 */}
         </div>
         ```
       - Import and use the useAnimationLoop hook (starts when audioReady becomes true).
       - Apply base Tailwind styles: dark background, white text, full viewport height.

    4. Update src/renderer/index.css: add any global styles needed (font imports, scrollbar hiding, selection color matching theme).
  </action>
  <verify>
    `npm start` -- app launches showing splash screen.
    Click "Click to Start" -- transitions to main layout with title bar.
    Title bar is draggable (window moves when dragging).
    macOS traffic lights are visible and functional (close/minimize/maximize).
    Console shows no errors. AudioContext state should be 'running' after click.
  </verify>
  <done>
    App launches with branded splash screen. Clicking start unlocks AudioContext and transitions to main instrument layout. Title bar supports window dragging with traffic light buttons. Dark theme applied.
  </done>
</task>

</tasks>

<verification>
1. `npm start` shows splash screen with Schmidi branding
2. Clicking start transitions to main layout (no flicker)
3. AudioContext state is 'running' after click (check via dev tools console)
4. Title bar is draggable, traffic lights work
5. `npx tsc --noEmit` passes
6. No console errors
</verification>

<success_criteria>
App launches with splash screen that unlocks AudioContext on click, transitions to a dark-themed main layout with custom title bar. Zustand store holds all UI state. Animation loop runs at 60fps polling voice states.
</success_criteria>

<output>
After completion, create `.planning/phases/01-audio-foundation/01-03-SUMMARY.md`
</output>
